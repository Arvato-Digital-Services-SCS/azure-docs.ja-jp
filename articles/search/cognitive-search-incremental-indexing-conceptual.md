---
title: 増分インデックス作成 (プレビュー)
titleSuffix: Azure Cognitive Search
description: スキル、スキルセット、インデクサー、データ ソースへのあらゆる更新に対処するために、最終的な整合性をデータに確保するよう AI エンリッチメント パイプラインを構成します。 現在、この機能はパブリック プレビュー段階にあります。
manager: nitinme
author: Vkurpad
ms.author: vikurpad
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: c44228d7e1456bce870765935beb011cb24626d5
ms.sourcegitcommit: 76b48a22257a2244024f05eb9fe8aa6182daf7e2
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/03/2019
ms.locfileid: "74790937"
---
# <a name="what-is-incremental-indexing-in-azure-cognitive-search"></a>Azure Cognitive Search におけるインデックスの増分作成とは

> [!IMPORTANT] 
> 増分インデックス機能は現在、パブリック プレビューの段階です。 このプレビュー バージョンはサービス レベル アグリーメントなしで提供されています。運用環境のワークロードに使用することはお勧めできません。 詳しくは、[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)に関するページをご覧ください。 [REST API バージョン 2019-05-06-Preview](search-api-preview.md) でこの機能を提供します。 現時点で、ポータルまたは .NET SDK はサポートされていません。

インデックスの増分作成は、Azure Cognitive Search の新機能であり、コグニティブ スキルセット内の強化されたコンテンツにキャッシュと状態を追加します。これにより、エンリッチメント パイプラインの個々のステップの処理と再処理を制御できます。 これにより、処理にかかる費用を節約できるだけでなく、より効率的なシステムを実現できます。 構造とコンテンツがキャッシュされるときに、インデクサーは、どのスキルが変更されたかを判断し、変更されたスキルとそのダウンストリームの従属スキルのみを実行することができます。 

インデックスの増分作成では、最新版のエンリッチメント パイプラインが、インデックス内のすべてのドキュメントの整合性を最小限の処理で保証します。 完全制御が求められるシナリオでは、きめ細かな制御手段を用いて、予想される動作をオーバーライドすることができます。 構成の詳細については、[インデックスの増分作成を設定する](search-howto-incremental-index.md)方法に関する記事を参照してください。

## <a name="indexer-cache"></a>インデクサー キャッシュ

インデックスの増分作成では、エンリッチメント パイプラインにインデクサー キャッシュが追加されます。 インデクサーは、ドキュメント解析から得られた結果と、ドキュメントごとの各スキルの出力をキャッシュします。 スキルセットが更新されたときには、変更済み (またはダウンストリーム) のスキルのみが再実行されます。 更新された結果がキャッシュに書き込まれ、インデックスとナレッジ ストア内のドキュメントが更新されます。

物理的には、キャッシュはストレージ アカウントです。 インデクサー キャッシュには、Search サービス内のすべてのインデックスが同じストレージ アカウントを共有できます。 それぞれのインデクサーには、一意かつ不変のキャッシュ識別子が割り当てられます。

### <a name="cache-configuration"></a>キャッシュの構成

インデックスの増分作成による恩恵を受けるためには、インデクサーの `cache` プロパティが設定されている必要があります。 次の例は、キャッシュが有効になっているインデクサーを示しています。 この構成の特定の部分については、次のセクションで説明します。

```json
{
    "name": "myIndexerName",
    "targetIndexName": "myIndex",
    "dataSourceName": "myDatasource",
    "skillsetName": "mySkillset",
    "cache" : {
        "storageConnectionString" : "Your storage account connection string",
        "enableReprocessing": true,
        "id" : "Auto generated Id you do not need to set"
    },
    "fieldMappings" : [],
    "outputFieldMappings": [],
    "parameters": {}
}
```

既存のインデクサーでこのプロパティを初めて設定する場合は、このプロパティもリセットする必要があります。これにより、データ ソース内のすべてのドキュメントが再度処理されます。 インデックスの増分作成の目標は、データ ソースや最新版のスキルセットとの整合性をインデックス内のドキュメントに確保することです。 この整合性の確保に向けて最初に行うべきことは、インデックスをリセットすることです。これにより、以前のバージョンのスキルセットによってエンリッチメントされたドキュメントがすべて削除されます。 最初に整合状態のベースラインを確立するためにインデクサーをリセットする必要があるのです。

### <a name="cache-lifecycle"></a>キャッシュのライフサイクル

キャッシュのライフサイクルは、インデクサーによって管理されます。 インデクサーの `cache` プロパティが null 値に設定されるか、接続文字列が変更された場合、既存のキャッシュは削除されます。 キャッシュのライフサイクルは、インデクサーのライフサイクルにも関係しています。 インデクサーが削除されると、関連付けられているキャッシュも削除されます。

### <a name="indexer-cache-mode"></a>インデクサー キャッシュのモード

インデクサー キャッシュには、データがキャッシュに書き込まれるだけの動作モードと、データがキャッシュに書き込まれてドキュメントの再エンリッチメントに使用される動作モードとがあります。  キャッシュの `enableReprocessing` プロパティを `false` に設定することで増分エンリッチメントを一時的に中断し、後から `true` に設定することで、増分エンリッチメントを再開して最終的な整合性を確保することができます。 ドキュメントのコーパス全体に対する整合性を確保するよりも新しいドキュメントのインデックス作成を優先したい場合には、この制御手法が特に効果的です。

## <a name="change-detection-override"></a>変更検出のオーバーライド

インデックスの増分作成では、エンリッチメント パイプラインのあらゆる側面を細かく制御できます。 変更によって意図しない結果が生じるような状況にも、この制御性によって対応することができます。 たとえば、スキルセットを編集したりカスタム スキルの URL を更新したりした場合、そのスキルに関してキャッシュされた結果がインデクサーによって無効化されます。 単にエンドポイントを別の VM に移動する場合や、既存のスキルを新しいアクセス キーで再デプロイするだけの場合、実際には既存のドキュメントを再処理する必要はありません。

明らかに必要なエンリッチメントのみをインデクサーで確実に処理できるよう、スキルセットに対する更新では、必要に応じてクエリ文字列パラメーター `disableCacheReprocessingChangeDetection` を `true` に設定することができます。 このパラメーターを設定すると、スキルセットに対する更新だけがコミットされ、変更が既存のコーパスに及ぼす影響は評価されません。

以下にクエリ文字列の使用例を示します。 これは、& で区切られたキー値のペアを含む要求の一部です。 

```http
PUT https://customerdemos.search.windows.net/skillsets/callcenter-text-skillset?api-version=2019-05-06-Preview&disableCacheReprocessingChangeDetection=true
```

## <a name="cache-invalidation"></a>キャッシュの無効化

逆のシナリオとして、新しいバージョンのカスタム スキルをデプロイするケースがあります。エンリッチメント パイプラインには何も変わりはないものの、更新されたモデルのメリットを反映するために、特定のスキルを無効化し、影響するすべてのドキュメントを再処理する必要があります。 そのような場合は、スキルセットに対してスキルの無効化操作を呼び出すことができます。 スキルのリセット API は、キャッシュ内の無効化すべきスキル出力のリストと共に POST 要求を受け取ります。 スキルのリセット API の詳細については、[インデクサーのリセット (Search REST API)](https://docs.microsoft.com/rest/api/searchservice/reset-indexer)に関する記事を参照してください。

## <a name="bi-directional-change-detection"></a>双方向の変更検出

インデクサーは、前進しながら新しいドキュメントを処理するだけではありません。逆行しながら過去に処理したドキュメントの整合性を確保できるようになりました。 この新機能については、エンリッチメント パイプライン コンポーネントに対する変更がどのようにインデクサーの処理につながるかを理解することが大切です。 インデクサーは、キャッシュされたコンテンツに対して相対的に無効化につながる変更または不整合につながる変更が見つかると、実行すべき処理をキューに格納します。

### <a name="invalidating-changes"></a>無効化につながる変更

無効化につながる変更はまれではありますが、エンリッチメント パイプラインの状態には重大な影響を及ぼします。 無効化につながる変更とは、キャッシュ全体の有効性が失われる変更をいいます。 たとえばデータ ソースの更新は、無効化につながる変更です。 キャッシュを無効化すべき変更ではないことがわかっているシナリオ (ストレージ アカウントのキーのローテーションなど) では、特定のリソースの更新操作が拒否されないよう、その操作の `ignoreResetRequirement` クエリ文字列パラメーターを `true` に設定する必要があります。

以下、キャッシュが無効化される可能性のある変更をすべて列挙します。

* データ ソースの種類に対する変更
* データ ソース コンテナーに対する変更
* データ ソースの資格情報
* データ ソースの変更検出ポリシー
* データ ソースの削除検出ポリシー
* インデクサーのフィールドのマッピング
* インデクサーのパラメーター
    * 解析モード
    * ファイル名拡張子を除外
    * ファイル名拡張子のインデックスを作成
    * サイズの大きいドキュメントのストレージ メタデータのみのインデックスを作成
    * 区切りテキストのヘッダー
    * 区切りテキストの区切り記号
    * ドキュメントのルート
    * 画像操作 (画像の抽出方法に対する変更)

### <a name="inconsistent-changes"></a>不整合につながる変更

たとえば、スキルセットに対する更新のうち、スキルの変更を伴うものは、不整合につながる変更です。 この変更によって、キャッシュの整合性が部分的に失われる可能性があります。 整合性を取り戻すための処理がインデクサーによって割り出されることになります。  

以下、キャッシュの不整合につながる変更をすべて列挙します。

* スキルセットに種類の異なるスキルがある。 スキルの OData 型が更新された。
* スキルに固有のパラメーター (url、defaults など) が更新された。
* スキルの出力が変更 (スキルから返される出力が追加または変更) された。
* 先祖の変更を伴うスキルの更新があった。スキルのチェーン (つまりスキルの入力) が変更された。
* アップストリームのスキルが無効化された (このスキルへの入力となっているスキルが更新された場合)。
* ドキュメントの再プロジェクションを伴う更新がナレッジ ストアのプロジェクション場所に生じた。
* ドキュメントの再プロジェクションを伴う変更がナレッジ ストアのプロジェクションに生じた。
* インデックスに対するドキュメントの再プロジェクションを伴う変更が、インデクサーの出力フィールドのマッピングに生じた。

## <a name="rest-api-reference-for-incremental-indexing"></a>増分インデックス作成の REST API リファレンス

REST `api-version=2019-05-06-Preview` には、インデクサー、スキルセット、データ ソースに追加された増分インデックス作成用の API が用意されています。 現在、リファレンス ドキュメントにはこれらの追加は含まれていません。 次のセクションでは、API の変更について詳しく説明します。

### <a name="indexers"></a>インデクサー

[インデクサーの作成](https://docs.microsoft.com/rest/api/searchservice/create-indexer)および[インデクサーの更新](https://docs.microsoft.com/rest/api/searchservice/update-indexer)では、キャッシュに関連した新しいプロパティを公開しています。

* `StorageAccountConnectionString`:中間の結果をキャッシュするために使用されるストレージ アカウントへの接続文字列。

* `CacheId`:`cacheId` は、このインデクサーのキャッシュとして使用される `annotationCache` ストレージ アカウント内のコンテナーの識別子です。 このインデクサーに固有のキャッシュであり、インデクサーが削除されて同じ名前で再作成されると、`cacheId` が再び生成されます。 `cacheId` を設定することはできません。常にサービスによって生成されます。

* `EnableReprocessing`:既定では `true` に設定されます。`false` に設定した場合でも、ドキュメントは引き続きキャッシュに書き込まれますが、そのキャッシュ データに基づいて既存のドキュメントが再処理されることはありません。

一部のインデクサー ([データ ソース](https://docs.microsoft.com/rest/api/searchservice/create-data-source)経由) では、クエリを使用してデータを取得します。 データを取得するクエリの場合、インデクサーでは、新しいクエリ文字列パラメーターもサポートされます。更新処理でキャッシュを無効化すべきでないときには、`ignoreResetRequirement` を `true` に設定する必要があります。

### <a name="skillsets"></a>スキルセット

スキルセットで新たにサポートされる操作はありませんが、新たにサポートされるクエリ文字列パラメーターはあります。最新のアクションに基づいて既存のドキュメントを更新したくない場合は、`disableCacheReprocessingChangeDetection` を `true` に設定する必要があります。

### <a name="datasources"></a>データソース

データソースで新たにサポートされる操作はありませんが、新たにサポートされるクエリ文字列パラメーターはあります。更新処理でキャッシュを無効化すべきでないときには、`ignoreResetRequirement` を `true` に設定する必要があります。

## <a name="best-practices"></a>ベスト プラクティス

インデックスの増分作成を使用するにあたっては、新しいインデクサーのキャッシュ プロパティを設定することによってインデックスの増分作成を構成するか、既存のインデクサーをリセットしてキャッシュ プロパティを設定する方法が推奨されます。

`ignoreResetRequirement` は慎重に使用してください。容易には検出できない不整合が意図せずデータに生じることがあります。

## <a name="takeaways"></a>重要なポイント

インデックスの増分作成は、データ ソース、スキル セットの現在のバージョン、インデクサーを含むエンリッチメント パイプラインのあらゆる側面に対するデータ ソースからの変更の追跡を拡張する強力な機能です。 スキルやスキルセット、エンリッチメントが進化する過程で、エンリッチメント パイプラインは最小限の作業を確実に実行する傍ら、ドキュメントの最終的な整合性を確保します。

## <a name="next-steps"></a>次の手順

既存のインデクサーにキャッシュを追加するか、新しいインデクサーを定義する際にキャッシュを追加して、インデックスの増分作成を実際に行ってみましょう。

> [!div class="nextstepaction"]
> [増分インデックス作成を設定する](search-howto-incremental-index.md)
