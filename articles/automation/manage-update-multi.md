---
title: 複数の Azure 仮想マシンの更新を管理する
description: この記事では、Azure 仮想マシンと Azure 以外の仮想マシンの更新プログラムを管理する方法について説明します。
services: automation
ms.subservice: update-management
ms.date: 03/26/2020
ms.topic: conceptual
ms.openlocfilehash: 6a878ecf4519a852a9798b320bda26cd490487a4
ms.sourcegitcommit: 4499035f03e7a8fb40f5cff616eb01753b986278
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/03/2020
ms.locfileid: "82731987"
---
# <a name="manage-updates-for-multiple-azure-virtual-machines"></a>複数の Azure 仮想マシンの更新を管理する

Azure Automation Update Management を使用すると、Windows および Linux の仮想マシンの更新プログラムとパッチを管理できます。 [Azure Automation](automation-offering-get-started.md) アカウントから、以下の操作を行うことができます。

- 仮想マシンをオンボードします。
- 利用可能な更新プログラムの状態を評価します。
- 必要な更新プログラムのインストールをスケジュールします。
- 展開結果を見直して、Update Management が有効になっているすべての仮想マシンに更新プログラムが正常に適用されたことを確認します。

Update Management のシステム必要条件の詳細については、[Update Management のクライアント要件](automation-update-management.md#client-requirements)に関するページを参照してください。

## <a name="prerequisites"></a>前提条件

* サポートされているオペレーティング システムのいずれかがインストールされている仮想マシンまたはコンピューター。
* Update Management にオンボードされている Linux VM の更新リポジトリへのアクセス。

## <a name="enable-update-management-for-azure-virtual-machines"></a>Update Management を Azure 仮想マシンに対して有効にする

Azure Portal で、Automation アカウントを開き、 **[Update Management]** を選択します。

**[Azure VM の追加]** を選択します。

![[Azure VM の追加] タブ](./media/manage-update-multi/update-onboard-vm.png)

利用を開始する仮想マシンを選択します。

**［Update Management を有効にする］** で、 **［有効化］** を選択して、仮想マシンをオンボードします。

![[更新管理の有効化] ダイアログ ボックス](./media/manage-update-multi/update-enable.png)

オンボードが終了すると、仮想マシンに対して Update Management が有効になります。

## <a name="enable-update-management-for-non-azure-virtual-machines-and-computers"></a>Azure 以外の仮想マシンとコンピューターに対して Update Management を有効にする

Windows および Linux で Update Management を有効にするには、企業ネットワークまたはその他のクラウド環境で実行されている VM にそれらの OS 用の Log Analytics エージェントをインストールする必要があります。 Azure の外部でホストされているコンピューターにエージェントをデプロイするためのシステム要件とサポートされている方法については、[Log Analytics エージェントの概要](../azure-monitor/platform/log-analytics-agent.md)に関するページを参照してください。

## <a name="view-computers-attached-to-your-automation-account"></a>Automation アカウントに接続されているコンピューターを表示する

マシンに対して Update Management を有効にした後、 **[コンピューター]** を選択することで、マシンの情報を表示できます。 コンピューターのマシン名、対応状況、環境、OS の種類、インストール済みの重要なセキュリティの更新プログラム、インストール済みのその他の更新プログラム、および更新エージェントの準備状況の情報を表示できます。

  ![[コンピューター] タブの表示](./media/manage-update-multi/update-computers-tab.png)

Update Management が最近有効になったコンピューターは、まだ評価されていないことがあります。 これらのコンピューターのコンプライアンスの対応状況は `Not assessed` です。 対応状況に使用される値の一覧を次に示します。

- `Compliant`:重要な更新プログラムとセキュリティ更新プログラムがすべてインストールされているコンピューター。
- `Non-compliant`:インストールされていない重要な更新プログラムまたはセキュリティ更新プログラムが少なくとも 1 つ存在するコンピューター。
- `Not assessed`:想定されている時間内にコンピューターから更新プログラムの評価データを受信していません。 Linux コンピューターでは、想定されている時間は、最後の 1 時間です。 Windows コンピューターでは、想定されている時間は、最後の 12 時間です。

エージェントの状態を表示するには、 **[エージェントの更新の準備]** 列のリンクを選択します。 このオプションを選択すると、ハイブリッド Worker ウィンドウが開いて、ハイブリッド worker の状態が表示されます。 次の図は、長期間 Update Management に接続されていないエージェントの例を示しています。

![[コンピューター] タブの表示](./media/manage-update-multi/update-agent-broken.png)

## <a name="view-an-update-assessment"></a>更新の評価を表示する

Update Management が有効になると、[更新の管理] ウィンドウが開きます。 **[不足している更新プログラム]** タブに、デプロイされていない更新プログラムの一覧が表示されます。

## <a name="collect-data"></a>データを収集する

仮想マシンとコンピューターにインストールされたエージェントは、更新プログラムに関するデータを収集します。 エージェントは、そのデータを Azure Update Management に送信します。

### <a name="supported-agents"></a>サポートされているエージェント

次の表では、このソリューションでサポートされている接続先ソースについて説明します。

| 接続先ソース | サポートされています | 説明 |
| --- | --- | --- |
| Windows エージェント |はい |Update Management は、Windows エージェントからシステムの更新プログラムに関する情報を収集した後、必要な更新プログラムのインストールを開始します。 |
| Linux エージェント |はい |Update Management は、Linux エージェントからシステムの更新プログラムに関する情報を収集した後、サポート対象のディストリビューションに対して必要な更新プログラムのインストールを開始します。 |
| Operations Manager 管理グループ |はい |Update Management は、接続された管理グループ内のエージェントからシステムの更新プログラムに関する情報を収集します。 |
| Azure ストレージ アカウント |いいえ |Azure Storage には、システムの更新プログラムに関する情報は含まれません。 |

### <a name="collection-frequency"></a>収集の頻度

コンピューターが更新プログラムのコンプライアンスを確認するためにスキャンを完了した後、エージェントによって情報が Azure Monitor ログに一括転送されます。 Windows コンピューターでは、コンプライアンス スキャンは既定で 12 時間ごとに実行されます。

このスキャン スケジュールに加えて、MMA の再起動後 15 分以内、更新プログラムのインストール前、および更新プログラムのインストール後に、更新プログラムのコンプライアンスを確認するためのスキャンが開始されます。

Linux コンピューターでは、コンプライアンス スキャンは既定で 1 時間ごとに実行されます。 MMA エージェントを再起動した場合は、コンプライアンス スキャンは 15 分以内に開始されます。

管理対象のコンピューターの更新されたデータがダッシュボードに表示されるまでに、30 分～ 6 時間かかる場合があります。

## <a name="schedule-an-update-deployment"></a>更新プログラムのデプロイをスケジュールする

更新プログラムをインストールするには、リリース スケジュールとサービス期間と合致する展開をスケジュールします。 デプロイに含める更新の種類を選択できます。 たとえば、緊急更新プログラムやセキュリティ更新プログラムを追加し、更新プログラムのロールアップを除外できます。

>[!NOTE]
>更新プログラムのデプロイをスケジュールすると、対象マシンへの更新プログラムのデプロイを処理する **Patch-MicrosoftOMSComputers** Runbook にリンクされた[スケジュール](shared-resources/schedules.md) リソースが作成されます。 デプロイの作成後に Azure portal または PowerShell を使用してこのスケジュール リソースを削除した場合、スケジュールされた更新プログラムのデプロイが壊れ、ポータルから再構成しようとするとエラーが発生します。 スケジュール リソースは、対応するデプロイ スケジュールを削除することによってのみ削除することができます。
>

1 台以上の仮想マシンの新しい更新プログラムのデプロイをスケジュールするには、 **［更新管理］** で、 **［更新プログラムの展開のスケジュール］** を選択します。

**[新しい更新プログラムの展開]** ウィンドウで、次の情報を指定します。

- **Name**:更新プログラムの展開を識別する一意の名前を入力します。
- **[オペレーティング システム]** : **[Windows]** または **[Linux]** を選択します。
- **[更新するグループ]** : サブスクリプション、リソース グループ、場所、およびタグの組み合わせに基づいてクエリを定義し、デプロイに含める Azure VM の動的グループを構築します。 Azure 以外の VM の場合は、保存された検索条件が使用され、デプロイに含める動的グループが作成されます。 詳細については、[動的グループ](automation-update-management-groups.md)に関するページを参照してください。
- **[更新するマシン]** :保存した検索条件、インポートしたグループを選択するか、[マシン] を選択し、更新するマシンを選択します。

   >[!NOTE]
   >[保存する検索条件] オプションを選択すると、マシン ID ではなく、その名前のみが返されます。 複数のリソース グループにまたがって同じ名前を持ついくつかの VM がある場合は、それらが結果で返されます。 条件に一致する一意の VM を確実に含めるには、 **[更新するグループ]** オプションを使用することをお勧めします。

   **[マシン]** を選択すると、マシンの準備状況が **[エージェントの更新の準備]** 列に示されます。 更新プログラムの展開をスケジュールする前にマシンの正常性状態を確認できます。 Azure Monitor ログでコンピューター グループを作成するさまざまな方法については、[Azure Monitor ログのコンピューター グループ](../azure-monitor/platform/computer-groups.md)に関するページを参照してください

  ![[新しい更新プログラムの展開] ウィンドウ](./media/manage-update-multi/update-select-computers.png)

- **[更新プログラムの分類]** :更新プログラムの展開に含めるソフトウェアの種類を選択します。 分類の種類の詳細については、「[更新プログラムの分類](automation-view-update-assessments.md#update-classifications)」をご覧ください。 分類の種類は次のとおりです。
  - 緊急更新プログラム
  - セキュリティ更新プログラム
  - 更新プログラムのロールアップ
  - Feature Pack
  - Service Pack
  - 定義の更新
  - ツール
  - 更新プログラム

- **[Updates to include/exclude]\(含める/除外する更新プログラム\)** : [Include/Exclude]\(含める/除外する\) ページが開きます。 含めるまたは除外する更新プログラムは別のタブに表示されます。 含める処理の方法については、「[更新プログラムのデプロイをスケジュールする](automation-tutorial-update-management.md#schedule-an-update-deployment)」を参照してください。

> [!NOTE]
> 包含より除外の方が優先されることを知っておく必要があります。 たとえば、除外ルール `*` を定義した場合、修正プログラムまたはパッケージはすべて除外されるためインストールされません。 除外されたパッチは、マシンに不足しているものとして表示されます。 Linux マシンでは、包含されているパッケージに除外された依存パッケージがある場合、パッケージはインストールされません。

> [!NOTE]
> 更新プログラムのデプロイ内容に、古い更新プログラムを指定することはできません。
>

- **[スケジュール設定]** :既定の日時 (現在の時刻から 30 分後) をそのまま使用できます。 別の時刻を指定することもできます。

   展開を 1 回だけ行うか、定期的なスケジュールで行うかを指定することもできます。 定期的なスケジュールを設定するには、 **[繰り返し]** の下の **[繰り返し]** を選択します。

   ![[スケジュール設定] ダイアログ ボックス](./media/manage-update-multi/update-set-schedule.png)

- **[事前スクリプトと事後スクリプト]** :デプロイの前後に実行するスクリプトを選択します。 詳細については、[事前および事後スクリプトの管理](pre-post-scripts.md)に関するページを参照してください。
- **[メンテナンス期間 (分)]** :更新プログラムを展開する期間を指定します。 この設定により、定義したサービス期間内は変更が確実に実行されます。

- **[Reboot control]\(再起動制御\)** - この設定は、更新デプロイでの再起動の処理方法を決定します。

   |オプション|説明|
   |---|---|
   |必要に応じて再起動| **(既定値)** 必要に応じて、メンテナンス ウィンドウで許可されている場合に再起動します。|
   |常に再起動|再起動は、必要かどうかに関係なく開始されます。 |
   |再起動しない|再起動は、必要かどうかに関係なく抑制されます。|
   |Only reboot - will not install updates (再起動のみ - 更新プログラムをインストールしない)|このオプションは、更新プログラムのインストールを無視し、再起動を開始するだけです。|

スケジュールの構成が完了したら、 **[作成]** ボタンを選択して、状態ダッシュボードに戻ります。 **[スケジュール済み]** の表に、作成した展開スケジュールが表示されます。

> [!NOTE]
> Update Management では、ファースト パーティの更新プログラムの展開と、修正プログラムの事前ダウンロードをサポートしています。 このためには、修正プログラムの適用対象システムでの変更が必要になります。お使いのシステムでこれらの設定を構成する方法については、[ファースト パーティと事前ダウンロードのサポート](automation-configure-windows-update.md#pre-download-updates)に関するセクションを参照してください。

## <a name="view-results-of-an-update-deployment"></a>更新プログラムのデプロイの結果を確認する

スケジュールされた展開の開始後、 **[更新の管理]** の **[更新プログラムの展開]** タブに、展開の状態が表示されます。

展開を現在実行中の場合、状態は **[処理中]** と表示されます。 展開が正常に終了すると、状態が **[成功]** に変わります。

展開時に 1 つ以上の更新プログラムでエラーが発生した場合、状態は **[部分的に失敗]** になります。

![更新プログラムの展開の状態](./media/manage-update-multi/update-view-results.png)

更新プログラムの展開に関するダッシュボードを表示するには、完了した展開を選択します。

[更新プログラムを実行した結果] ウィンドウには、仮想マシンに対する更新プログラムの合計数と展開結果が表示されます。 右側の表には、各更新プログラムとインストールの結果の詳細が示されます。 インストールの結果は、次のいずれかの値になります。

- `Not attempted`:定義されたメンテナンス期間に基づき、時間が十分ではなかったため、更新プログラムがインストールされませんでした。
- `Succeeded`:更新できました。
- `Failed`:更新できませんでした。

展開によって作成されたログ エントリをすべて表示するには、 **[すべてのログ]** を選択します。

対象となる仮想マシンでの更新プログラムの展開を管理する Runbook のジョブ ストリームを確認するには、[出力] タイルを選択します。

展開で発生したエラーの詳細情報を確認するには、 **[エラー]** を選択します。

## <a name="next-steps"></a>次のステップ

Update Management ログ、出力、エラーの詳細については、[Update Management の更新レコードに対するクエリの実行](automation-update-management-query-logs.md)に関するページを参照してください。
