---
title: Azure VM の更新プログラムとパッチの管理
description: この記事では、Azure Automation Update Management を使用して、お使いの Azure および非 Azure VM の更新プログラムとパッチを管理する方法の概要について説明します。
services: automation
ms.subservice: update-management
ms.topic: tutorial
ms.date: 04/06/2020
ms.custom: mvc
ms.openlocfilehash: 62c661f75aef77117a61be7e802562e6dde17ba5
ms.sourcegitcommit: 5e49f45571aeb1232a3e0bd44725cc17c06d1452
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2020
ms.locfileid: "81604674"
---
# <a name="manage-updates-and-patches-for-your-azure-vms"></a>Azure VM の更新プログラムとパッチの管理

Update Management のソリューションを使用すると、仮想マシンの更新プログラムとパッチを管理できます。 このチュートリアルでは、利用可能な更新プログラムの状態の評価、必要な更新プログラムのインストールのスケジュール設定、展開の結果の確認、更新プログラムが正常に適用されたことを確認するアラートの作成を迅速に行う方法について説明します。

価格情報については、[Update Management の Automation の価格](https://azure.microsoft.com/pricing/details/automation/)に関するページをご覧ください。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * 更新の評価を表示する
> * アラートを構成する
> * 更新プログラムのデプロイをスケジュールする
> * デプロイの結果を表示する

## <a name="prerequisites"></a>前提条件

このチュートリアルを完了するには、次のものが必要です。

* 1 つ以上の VM に対して有効になっている [Update Management](automation-update-management.md) ソリューション。
* オンボードする[仮想マシン](../virtual-machines/windows/quick-create-portal.md)。

## <a name="sign-in-to-azure"></a>Azure へのサインイン

Azure Portal ( https://portal.azure.com ) にサインインします。

## <a name="view-update-assessment"></a>更新の評価を確認する

Update Management を有効にすると、[更新プログラムの管理] ページが開きます。 更新プログラムが不足していると識別された場合は、 **[不足している更新プログラム]** タブに、足りない更新プログラムの一覧が表示されます。

**[情報リンク]** で更新プログラムのリンクを選択すると、更新プログラムのサポート記事が表示されます。 更新プログラムに関する重要情報を確認できます。

![更新ステータスを確認する](./media/automation-tutorial-update-management/manageupdates-view-status-win.png)

更新プログラムの別の場所をクリックすると、選択した更新プログラムの [ログ検索] ペインが開きます。 その更新プログラムについて、ログ検索のクエリが事前に定義されています。 このクエリを変更するか独自のクエリを作成して、お使いの環境に展開されている更新プログラムまたは不足している更新プログラムに関する詳細情報を確認できます。

![更新ステータスを確認する](./media/automation-tutorial-update-management/logsearch.png)

## <a name="configure-alerts"></a>アラートを構成する

この手順では、更新プログラムの展開の状態を通知するアラートの設定について説明します。

### <a name="alert-conditions"></a>アラートの条件

お使いの Automation アカウントで、 **[監視]** の **[アラート]** に移動し、 **[新しいアラート ルール]** をクリックします。

お使いの Automation アカウントは、リソースとしてあらかじめ選択されています。 これを変更する場合は、 **[選択]** をクリックします。 [リソースを選択してください] ページで、 **[リソースの種類でフィルター]** ドロップダウン メニューから **[Automation アカウント]** を選択します。 お使いの Automation アカウントを選択し、 **[完了]** を選択します。

**[条件の追加]** をクリックして、お客様の更新プログラムの展開に適したシグナルを選択します。 次の表は、使用できる 2 つのシグナルの詳細を示しています。

|シグナル名|Dimensions|説明|
|---|---|---|
|`Total Update Deployment Runs`|- Update Deployment Name (更新プログラムの展開の名前)<br>- Status (状態)|このシグナルは、更新プログラムの展開の全体的な状態を通知します。|
|`Total Update Deployment Machine Runs`|- Update Deployment Name (更新プログラムの展開の名前)</br>- Status (状態)</br>- Target Computer (ターゲット コンピューター)</br>- Update Deployment Run ID (更新プログラムの展開の実行 ID)|このシグナルは、特定のマシンを対象とした更新プログラムの展開の状態を通知します。|

ディメンションには、リストから有効な値を選択します。 必要な値がリストにない場合は、ディメンションの横にある **\+** 記号をクリックしてカスタム名を入力します。 その後、検索対象の値を選択します。 ディメンションにすべての値を選択したい場合は、 **[選択]\*** ボタンをクリックします。 ディメンションに値を選択しなかった場合、Update Management ではそのディメンションが無視されます。

![シグナル ロジックの構成](./media/automation-tutorial-update-management/signal-logic.png)

**[アラート ロジック]** の **[しきい値]** に「**1**」を入力します。 完了したら、 **[完了]** をクリックします。

### <a name="alert-details"></a>[アラートの詳細]

**[2. アラートの詳細を定義します]** で、アラートの名前と説明を入力します。 成功した実行の場合 **[重大度]** を **[Informational(Sev 2)]\(情報 (重大度 2)\)** に設定し、失敗した実行の場合 **[Informational(Sev 1)]\(情報 (重大度 1)\)** に設定します。

![シグナル ロジックの構成](./media/automation-tutorial-update-management/define-alert-details.png)

**[アクション グループ]** の **[新規作成]** を選択します。 アクション グループとは、複数のアラートで使用できるアクションのグループです。 このアクションには、メール通知、Runbook、Webhook などを含めることができます。 アクション グループの詳細については、[アクション グループの作成および管理](../azure-monitor/platform/action-groups.md)に関するページを参照してください。

**[アクション グループ名]** フィールドに、アラートの名前と短縮名を入力します。 Update Management では、指定のグループを使用して通知を送信する際にアクション グループのフル ネームの代わりに短縮名を使用します。

**[アクション]** で、**メール通知**など、アクションの名前を入力します。 **[アクションの種類]** で、 **[Email/SMS/Push/Voice]\(メール、SMS、プッシュ、音声\)** を選択します。 **[詳細]** で、 **[詳細を編集する]** を選択します。

[電子メール/SMS/プッシュ/音声] ペインで、名前を入力します。 **[電子メール]** チェック ボックスをオンにして、有効な電子メール アドレスを入力します。

![電子メール アクション グループの構成](./media/automation-tutorial-update-management/configure-email-action-group.png)

[Email/SMS/Push/Voice]\(メール、SMS、プッシュ、音声\) ペインで、 **[OK]** をクリックします。 [アクション グループの追加] ペインで、 **[OK]** をクリックします。

アラート メールの件名をカスタマイズするには、 **[ルールの作成]** の **[アクションをカスタマイズする]** で、 **[メールの件名]** を選択します。 完了したら、 **[アラート ルールの作成]** を選択します。 このアラートにより、更新プログラムの展開が成功したことと、その更新プログラムの展開の実行対象となったマシンが通知されます。

## <a name="schedule-an-update-deployment"></a>更新プログラムのデプロイをスケジュールする

次に、リリース スケジュールとサービス期間に従って展開をスケジュールし、更新プログラムをインストールします。 展開に含める更新プログラムの種類を選択できます。 たとえば、緊急更新プログラムやセキュリティ更新プログラムを追加し、更新プログラムのロールアップを除外できます。

>[!NOTE]
>更新プログラムの展開をスケジュールすると、対象マシンへの更新プログラムの展開を処理する **Patch-MicrosoftOMSComputers**Runbook にリンクされた[スケジュール](shared-resources/schedules.md) リソースが作成されます。 展開の作成後に Azure portal または PowerShell を使用してこのスケジュール リソースを削除した場合、スケジュールされた更新プログラムの展開が破棄され、ポータルからスケジュール リソースを再構成しようとするとエラーが表示されます。 スケジュール リソースは、対応するデプロイ スケジュールを削除することによってのみ削除することができます。  

VM の新しい更新プログラムの展開をスケジュールするには、 **[更新の管理]** に移動し、 **[更新プログラムの展開のスケジュール]** を選択します。

**[新しい更新プログラムの展開]** で、次の情報を指定します。

* **Name**:更新プログラムの展開に一意の名前を入力します。

* **[オペレーティング システム]** :更新プログラムの展開の対象となる OS を選択します。

* **[更新するグループ (プレビュー)]** :サブスクリプション、リソース グループ、場所、タグを組み合わせたクエリを定義し、展開に含める Azure VM の動的グループを構築します。 詳しくは、[動的グループ](automation-update-management-groups.md)に関するページをご覧ください。

* **[更新するマシン]** :保存した検索、インポートしたグループを選択するか、ドロップダウン メニューから **[マシン]** を選択し、個々のマシンを選択します。 **[マシン]** を選択した場合、各マシンの準備状況が **[エージェントの更新の準備]** 列に表示されます。 Azure Monitor ログでコンピューター グループを作成するさまざまな方法については、[Azure Monitor ログのコンピューター グループ](../azure-monitor/platform/computer-groups.md)に関するページを参照してください

* **[更新プログラムの分類]** :製品ごとに、更新プログラムの展開に含めるものを除き、サポート対象の更新プログラムの分類すべての選択を解除します。 このチュートリアルでは、全製品に選択されているすべての種類をそのままにします。

  分類の種類は次のとおりです。

   |OS  |Type  |
   |---------|---------|
   |Windows     | 緊急更新プログラム</br>セキュリティ更新プログラム</br>更新プログラムのロールアップ</br>Feature Pack</br>Service Pack</br>定義の更新</br>ツール</br>更新プログラム<br>Driver        |
   |Linux     | 緊急更新プログラムとセキュリティ更新プログラム</br>他の更新プログラム       |

   分類の種類の説明については、「[更新プログラムの分類](automation-view-update-assessments.md#update-classifications)」を参照してください。

* **[Updates to include/exclude]\(包含/除外する更新プログラム\)** : [包含/除外] ページを開きます。 包含または除外する更新プログラムは、サポート技術情報の記事の ID 番号を指定することで、別々のタブに表示されます。 1 つ以上の ID 番号を指定する場合は、更新プログラムの展開ですべての分類を削除するか、チェック ボックスをオフにする必要があります。 これにより、更新プログラムの ID を指定しても、更新プログラム パッケージに他の更新プログラムが含まれなくなります。

> [!NOTE]
> 包含より除外が優先されることを知っておくことが重要です。 たとえば、除外ルール `*` を定義した場合、パッチまたはパッケージはすべて除外されるため、Update Management によってインストールされることはありません。 除外されたパッチは、マシンに不足しているものとして表示されます。 Linux マシンでは、除外された依存パッケージを含むパッケージを含めた場合、メイン パッケージはインストールされません。

> [!NOTE]
> 更新プログラムの展開に含めるよう、古くなった更新プログラムを指定することはできません。
>

* **[スケジュール設定]** :[スケジュール設定] ペインが開きます。 既定の開始時刻は、現在の時刻の 30 分後です。 開始時刻は、10 分後以降の将来の任意の時点に設定できます。

   展開を 1 回行うか、定期的なスケジュールを設定するかを指定することもできます。 **[繰り返し]** で **[1 回]** を選択します。 既定値を 1 日のままにし、 **[OK]** をクリックします。 これらのエントリにより、定期的なスケジュールが設定されます。

* **[事前スクリプトと事後スクリプト]** :デプロイの前後に実行するスクリプトを選択します。 詳細については、[事前および事後スクリプトの管理](pre-post-scripts.md)に関するページを参照してください。

* **[メンテナンス期間 (分)]** :既定値をそのまま使用します。 メンテナンス期間によって、更新プログラムをインストールするために許容される時間を制御します。 メンテナンス期間を指定するときは、次の詳細を考慮してください。

  * メンテナンス期間によって、インストールされる更新プログラムの数が制御されます。
  * メンテナンス期間の終了が近づいている場合でも、Update Management では、新しい更新プログラムのインストールは停止されません。
  * メンテナンス期間を超過した場合でも、進行中の更新は終了されません。
  * Windows でメンテナンス期間が超過した場合、Service Pack の更新プログラムのインストールに時間がかかることが原因であることがよくあります。

  > [!NOTE]
  > Ubuntu でメンテナンス期間外に更新プログラムが適用されないようにするには、無人アップグレード パッケージを再構成して自動更新を無効にします。 パッケージの構成方法については、[Ubuntu サーバー ガイドの自動更新に関するトピック](https://help.ubuntu.com/lts/serverguide/automatic-updates.html)をご覧ください。

* **[再起動のオプション]** : 再起動を処理するためのオプションを指定するために使用します。 次のオプションを使用できます。
  * 必要に応じて再起動 (既定値)
  * 常に再起動
  * 再起動しない
  * Only reboot - doesn't install updates (再起動のみ - 更新プログラムはインストールされません)

> [!NOTE]
> **[再起動のオプション]** が **[再起動しない]** に設定されている場合、「[再起動の管理に使われるレジストリ キー](/windows/deployment/update/waas-restart#registry-keys-used-to-manage-restart)」に記載されているレジストリ キーにより、再起動イベントが発生する可能性があります。

スケジュールの構成が完了したら、 **[作成]** をクリックします。

![更新プログラムのスケジュール設定ウィンドウ](./media/automation-tutorial-update-management/manageupdates-schedule-win.png)

状態ダッシュボードに戻ります。 **[スケジュールされた更新プログラムの展開]** を選択して、作成された展開スケジュールを表示します。

> [!NOTE]
> Update Management では、ファーストパーティの更新プログラムの展開とパッチの事前ダウンロードがサポートされています。 このサポートには、パッチ適用対象のシステムに対する変更が必要になります。 お使いのシステムでこれらの設定を構成する方法については、[ファーストパーティと事前ダウンロードのサポート](automation-configure-windows-update.md)に関するページを参照してください。

更新プログラムの展開はプログラムで作成することもできます。 REST API を使用して更新プログラムの展開を作成する方法については、「[ソフトウェア更新プログラムの構成 - 作成](/rest/api/automation/softwareupdateconfigurations/create)」を参照してください。 週単位の更新プログラムの展開を作成するために使用できるサンプル Runbook もあります。 この Runbook について詳しくは、「[Create a weekly update deployment for one or more VMs in a resource group](https://gallery.technet.microsoft.com/scriptcenter/Create-a-weekly-update-2ad359a1)」(リソース グループ内の VM に対して週単位の更新プログラムのデプロイを作成する) をご覧ください。

## <a name="view-results-of-an-update-deployment"></a>更新プログラムのデプロイの結果を確認する

スケジュールされた展開の開始後、 **[更新の管理]** の **[更新プログラムの展開]** タブに、展開の状態が表示されます。 展開が現在実行中の場合、状態は **[処理中]** と表示されます。 展開が正常に終了すると、状態が **[成功]** に変わります。 展開に含まれる 1 つ以上の更新プログラムでエラーが発生した場合、状態は **[Partially failed]\(部分的に失敗\)** になります。

完了した更新プログラムの展開を選択すると、そのダッシュボードが表示されます。

![特定の展開に関する更新プログラムの展開ステータスのダッシュボード](./media/automation-tutorial-update-management/manageupdates-view-results.png)

**[更新プログラムを実行した結果]** には、VM 上の更新プログラムの合計数と展開結果が表示されます。 右側の表には、各更新プログラムとインストールの結果の詳細が示されます。

使用できる値は次のとおりです。

* **試行されていません**:定義されたメンテナンス期間を基準とした場合に時間が十分ではなかったため、更新プログラムがインストールされませんでした。
* **[成功]** : 更新できました。
* **[失敗]** : 更新できませんでした。

展開によって作成されたログ エントリをすべて表示するには、 **[すべてのログ]** を選択します。

ターゲット VM での更新プログラムの展開を管理する Runbook のジョブ ストリームを確認するには、 **[出力]** を選択します。

展開で発生したエラーの詳細情報を確認するには、 **[エラー]** を選択します。

更新プログラムの展開が成功すると、次のような確認メールが届きます。

![電子メール アクション グループの構成](./media/automation-tutorial-update-management/email-notification.png)

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、以下の内容を学習しました。

> [!div class="checklist"]
> * Update Management のために VM をオンボードする
> * 更新の評価を表示する
> * アラートを構成する
> * 更新プログラムのデプロイをスケジュールする
> * デプロイの結果を表示する

更新の管理ソリューションの概要に進みます。

> [!div class="nextstepaction"]
> [更新の管理ソリューション](automation-update-management.md)