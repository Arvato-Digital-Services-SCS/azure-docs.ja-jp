---
title: Azure HPC Cache にストレージを追加する
description: Azure HPC Cache で長期的なファイルの保管にオンプレミス NFS システムまたは Azure BLOB コンテナーを使用できるようにストレージ ターゲットを定義する方法
author: ekpgh
ms.service: hpc-cache
ms.topic: conceptual
ms.date: 12/30/2019
ms.author: rohogue
ms.openlocfilehash: a68bf06bad995f71bedf6a5bdedcb676737a8c61
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "79233443"
---
# <a name="add-storage-targets"></a>ストレージ ターゲットを追加する

"*ストレージ ターゲット*" は、Azure HPC Cache インスタンスを通じてアクセスされるファイルのバックエンド ストレージです。 NFS ストレージ (オンプレミスのハードウェア システムなど) を追加できるほか、Azure BLOB にデータを格納することができます。

1 つのキャッシュに対して最大 10 個の異なるストレージ ターゲットを定義できます。 このキャッシュでは、すべてのストレージ ターゲットが 1 つの集約された名前空間で提供されます。

キャッシュの仮想ネットワークからストレージのエクスポートにアクセスできなければならないことに注意してください。 オンプレミスのハードウェア ストレージの場合、NFS ストレージへのアクセスに使用されるホスト名を解決できる DNS サーバーの設定が必要になることがあります。 詳細については、「[DNS アクセス](hpc-cache-prereqs.md#dns-access)」を参照してください。

キャッシュを作成した後で、ストレージ ターゲットを追加します。 この手順は、追加するのが Azure Blob Storage であるか NFS エクスポートであるかによって若干異なります。 それぞれの詳細を以下に示します。

## <a name="open-the-storage-targets-page"></a>ストレージ ターゲットのページを開く

Azure portal からキャッシュ インスタンスを開き、左側のサイド バーにある **[ストレージ ターゲット]** をクリックします。 ストレージ ターゲットのページには、既存のターゲットがすべて表示されるほか、新たに追加するためのリンクが表示されます。

![サイドバーの [ストレージ ターゲット] リンクのスクリーンショット。[設定] と [監視] というカテゴリ見出しの間にある [構成] という見出しの下にあります](media/hpc-cache-storage-targets-sidebar.png)

## <a name="add-a-new-azure-blob-storage-target"></a>新しい Azure Blob Storage ターゲットを追加する

新しい Blob Storage ターゲットには、空の BLOB コンテナーか、Azure HPC Cache クラウド ファイル システム フォーマットでデータが事前設定されているコンテナーが必要です。 BLOB コンテナーの事前読み込みの詳細については、[Azure Blob Storage へのデータの移動](hpc-cache-ingest.md)に関するページを参照してください。

追加する直前に、このページから新しいコンテナーを作成できます。

Azure BLOB コンテナーを定義するには、次の情報を入力します。

![新しい Azure Blob Storage ターゲットの情報が事前設定されている [ストレージ ターゲットの追加] ページのスクリーンショット](media/hpc-cache-add-blob.png)

* **[ストレージ ターゲット名]** - Azure HPC Cache 内でこのストレージ ターゲットを識別する名前を設定します。
* **[ターゲットの種類]** - **[BLOB]** を選択します。
* **[ストレージ アカウント]** - 使用するアカウントを選択します。

  [アクセス ロールの追加](#add-the-access-control-roles-to-your-account)に関するセクションの説明に従って、ストレージ アカウントへのアクセスをキャッシュ インスタンスに承認する必要があります。

  使用できるストレージ アカウントの種類の詳細については、「[Blob Storage の要件](hpc-cache-prereqs.md#blob-storage-requirements)」を参照してください。

* **[ストレージ コンテナー]** - このターゲットの BLOB コンテナーを選択するか、 **[新規作成]** をクリックします。

  ![新しいコンテナーの名前とアクセス レベル (プライベート) を指定するダイアログのスクリーンショット](media/add-blob-new-container.png)

* **[Virtual namespace path]\(仮想名前空間パス\)** - このストレージ ターゲットに使用するクライアント側のファイル パスを設定します。 仮想名前空間の機能の詳細については、「[集約された名前空間を構成する](hpc-cache-namespace.md)」を参照してください。

完了したら、 **[OK]** をクリックしてストレージ ターゲットを追加します。

> [!NOTE]
> お使いのストレージ アカウント ファイアウォールが "選択されているネットワーク" のみにアクセスできるように制限されている場合、「[BLOB ストレージ アカウントのファイアウォール設定を回避する](hpc-cache-blob-firewall-fix.md)」に記されている一時的な回避策をご利用ください。

### <a name="add-the-access-control-roles-to-your-account"></a>アクセス制御ロールをアカウントに追加する

Azure HPC Cache では、[ロールベースのアクセス制御 (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/index) を使用して、Azure Blob Storage ターゲットのストレージ アカウントへのアクセスをキャッシュ サービスに承認します。

ストレージ アカウント所有者は、"HPC Cache リソース プロバイダー" ユーザーの[ストレージ アカウント共同作成者](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-account-contributor)ロールと[ストレージ BLOB データ共同作成者](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor)ロールを明示的に追加する必要があります。

この作業は事前に行えるほか、Blob Storage ターゲットを追加するページ上のリンクをクリックして行うこともできます。 ロールの設定を Azure 環境経由で反映させるとき、最大 5 分かかる場合があることにご留意ください。ロールの追加後、少し待ってからストレージ ターゲットを作成してください。

RBAC ロールを追加する手順:

1. ストレージ アカウントの **[アクセス制御 (IAM)]** ページを開きます ( **[ストレージ ターゲットの追加]** ページのリンクをクリックすると自動的に、選択したアカウントについて、このページが表示されます)。

1. ページ上部の **+** をクリックして **[ロールの割り当てを追加する]** を選択します。

1. [ストレージ アカウント共同作成者] ロールを一覧から選択します。

1. **[アクセスの割り当て先]** フィールドでは、既定値を選択したままにしてください ("Azure AD のユーザー、グループ、サービス プリンシパル")。  

1. **[選択]** フィールドで、"hpc" を検索します。  この文字列は "HPC Cache リソース プロバイダー" という名前の 1 つのセキュリティ プリンシパルと一致するはずです。 そのプリンシパルをクリックして選択します。

   > [!NOTE]
   > "hpc" の検索が機能しない場合は、代わりに文字列 "storagecache" を使用してみてください。 (一般提供開始前に) プレビューに参加したユーザーは、サービス プリンシパルに以前の名前を使用しなければならない可能性があります。

1. 下部にある **[保存]** をクリックします。

1. このプロセスを繰り返して、"Storage Blob Data Contributor" というロールを割り当てます。  

![ロールの割り当ての追加の GUI のスクリーンショット](media/hpc-cache-add-role.png)

## <a name="add-a-new-nfs-storage-target"></a>新しい NFS ストレージ ターゲットを追加する

NFS ストレージ ターゲットには、BLOB ストレージ ターゲットよりも多くのフィールドがあります。 これらのフィールドでは、ストレージ エクスポートへの到達方法やそのデータを効率的にキャッシュする方法を指定します。 また、NFS ストレージ ターゲットでは、利用できるエクスポートが NFS ホストに複数ある場合、複数の名前空間パスを作成できます。

![NFS ターゲットが定義されている [ストレージ ターゲットの追加] ページのスクリーンショット](media/hpc-cache-add-nfs-target.png)

NFS を使用したストレージ ターゲットについて次の情報を入力します。

* **[ストレージ ターゲット名]** - Azure HPC Cache 内でこのストレージ ターゲットを識別する名前を設定します。

* **[ターゲットの種類]** - **[NFS]** を選択します。

* **[ホスト名]** - NFS ストレージ システムの IP アドレスまたは完全修飾ドメイン名を入力します (ドメイン名を使用するのは、名前を解決できる DNS サーバーにキャッシュからアクセスできる場合のみです)。

* **[使用モデル]** - ワークフローに基づいていずれかのデータ キャッシュ プロファイルを選択します ([後出の「使用モデルを選択する」](#choose-a-usage-model)を参照)。

### <a name="nfs-namespace-paths"></a>NFS 名前空間パス

各パスが同じストレージ システム上の別のエクスポートまたはサブディレクトリを表している限り、1 つの NFS ストレージ ターゲットに複数の仮想パスを使用できます。

1 つのストレージ ターゲットからすべてのパスを作成します。

ストレージ ターゲットではいつでも、[名前空間パスを追加したり、編集したり](hpc-cache-edit-storage.md)できます。

各名前空間パスに対して、次の値を入力します。

* **[Virtual namespace path]\(仮想名前空間パス\)** - このストレージ ターゲットに使用するクライアント側のファイル パスを設定します。 仮想名前空間の機能の詳細については、「[集約された名前空間を構成する](hpc-cache-namespace.md)」を参照してください。

<!--  The virtual path should start with a slash ``/``. -->

* **[NFS export path]\(NFS エクスポート パス\)** - NFS エクスポートのパスを入力します。

* **[Subdirectory path]\(サブディレクトリ パス\)** - エクスポートの特定のサブディレクトリをマウントしたい場合は、ここに入力します。 それ以外の場合、このフィールドは空白のままにしてください。

完了したら、 **[OK]** をクリックしてストレージ ターゲットを追加します。

### <a name="choose-a-usage-model"></a>使用モデルを選択する
<!-- referenced from GUI - update aka.ms link if you change this heading -->

NFS ストレージ システムを指すストレージ ターゲットを作成するときは、そのターゲットの "*使用モデル*" を選択する必要があります。 どのようにデータがキャッシュされるかは、このモデルによって決まります。

次の 3 つのオプションがあります。

* **負荷が高く、頻度の低い書き込みを読み取ります** - 静的、またはほとんど変更されないファイルへの読み取りアクセスを速くする場合にこのオプションを使用します。

  このオプションを選択すると、クライアントにより読み取られるファイルがキャッシュされますが、書き込みは直後にバックエンド ストレージに渡されます。 キャッシュに格納されているファイルが NFS ストレージ ボリューム上のファイルと比較されることはありません。

  最初にキャッシュに書き込まず、ストレージ システムで直接、ファイルが変更されるリスクがある場合、このオプションは使用しないでください。 直接変更されてしまうと、キャッシュされたバージョンのファイルはバック エンドからの変更で更新されず、データ セットに整合性がなくなります。

* **書き込みが 15% を超えています** - このオプションを使用すると、書き込みと読み取りの両方が速くなります。 このオプションを使用するとき、クライアントでは、バックエンド ストレージを直接マウントするのではなく、Azure HPC Cache 経由でファイルにアクセスする必要があります。 キャッシュされたファイルでは、バック エンドで格納されていない最近の変更が反映されます。

  この使用モデルでは、キャッシュのファイルがバックエンド ストレージのファイルに対して照合されることはありません。 キャッシュされたバージョンのファイルの方が新しいと見なされます。 キャッシュに存在する変更後のファイルは、追加の変更なしでキャッシュに 1 時間留まった後にようやくバックエンド ストレージ システムに書き込まれます。

* **クライアントは、キャッシュをバイパスして NFS ターゲットに書き込みます** - ワークフローのクライアントで、先にキャッシュに書き込まず、ストレージ システムにデータが直接書き込まれる場合にこのオプションを選択します。 クライアントによって要求されたファイルがキャッシュされますが、クライアントからのそれらのファイルの変更は、直後にバックエンド ストレージ システムに戻されます。

  この使用モデルでは、キャッシュに存在するファイルの更新がないか、バックエンド バージョンが頻繁に確認されます。 この検証によって、キャッシュの外でファイルを変更することが可能になり、同時にデータの整合性が維持されます。

このテーブルは、使用モデルの違いをまとめたものです。

| 使用モデル | キャッシュ モード | バックエンド検証 | ライトバックの最大遅延 |
| ---- | ---- | ---- | ---- |
| 負荷が高く、頻度の低い書き込みを読み取ります | Read | なし | なし |
| 書き込みが 15% を超えています | 読み取り/書き込み | なし | 1 時間 |
| クライアントはキャッシュをバイパス | Read | 30 秒 | なし |

## <a name="next-steps"></a>次のステップ

ストレージ ターゲットの作成後は、次のいずれかのタスクを検討してください。

* [Azure HPC キャッシュをマウントする](hpc-cache-mount.md)
* [Azure Blob Storage にデータを移動する](hpc-cache-ingest.md)

設定を更新する必要がある場合、[ストレージ ターゲットを編集](hpc-cache-edit-storage.md)できます。
