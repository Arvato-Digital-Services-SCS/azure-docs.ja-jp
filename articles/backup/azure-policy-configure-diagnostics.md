---
title: 大規模なコンテナーの診断設定を構成する
description: Azure Policy を使用して、特定のスコープ内のすべてのコンテナーに対してログ分析診断設定を構成します
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: c92957cab3e1ed745e7031e3c6f32e7ecda550a5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "77584508"
---
# <a name="configure-vault-diagnostics-settings-at-scale"></a>大規模なコンテナーの診断設定を構成する

Azure Backup によって提供されるレポート作成ソリューションは、ログ分析 (LA) を活用します。 特定のコンテナーのデータを LA に送信するには、そのコンテナーに対して [診断設定](https://docs.microsoft.com/azure/backup/backup-azure-diagnostic-events) を作成する必要があります。

多くの場合、資格情報コンテナーごとに手動で診断設定を追加することは面倒なタスクです。 また、作成された新しいコンテナーでも、このコンテナーのレポートを表示するには、診断設定を有効にする必要があります。 

(同期先としての LA を使用した) 大規模な診断設定の作成を簡単にするために、Azure Backup には、組み込みの [Azure Policy](https://docs.microsoft.com/azure/governance/policy/)が用意されています。 このポリシーは、特定のサブスクリプションまたはリソース グループ内のすべてのコンテナーにLA診断設定を追加します。 次のセクションでは、このポリシーの使用方法について説明します。

## <a name="supported-scenarios"></a>サポートされるシナリオ

* このポリシーは、特定のサブスクリプション (またはサブスクリプション内のリソース グループ) 内のすべての Recovery Services コンテナーに一度に適用することができます。 ポリシーを割り当てるユーザーは、ポリシーが割り当てられているサブスクリプションへの「所有者」アクセス権を持っている必要があります。

* (診断データの送信先となる) ユーザーによって指定された LA ワークスペースは、ポリシーが割り当てられているコンテナーとは異なるサブスクリプションに存在することができます。 ユーザーは、指定された LA ワークスペースが存在するサブスクリプションへの「閲覧者」、「共同作成者」、または「所有者」のアクセス権を持っている必要があります。

* 管理グループのスコープは、現在サポートされていません。

* 組み込みのポリシーは、現在、国内のクラウドでは使用できません。

## <a name="assigning-the-built-in-policy-to-a-scope"></a>組み込みポリシーをスコープに割り当てる

必要なスコープのコンテナーにポリシーを割り当てるには、次の手順に従ってください。

1. Azure Portal にサインインし、 **[ポリシー]** ダッシュボードに移動します。
2. 左側のメニューの **[定義]** を選択して、Azure リソース全体にわたるすべての組み込みポリシーの一覧を取得します。
3. **[カテゴリ] = [監視]** のリストをフィルター処理します。 **[プレビュー] という名前のポリシーを検索します。リソース固有のカテゴリの Log Analytics ワークスペースに Recovery Services コンテナーの診断設定をデプロイします**。

![ポリシー定義ブレード](./media/backup-azure-policy-configure-diagnostics/policy-definition-blade.png)

4. ポリシーの名前をクリックします。 このポリシーの詳細な定義にリダイレクトされます。

![ポリシー定義の詳細](./media/backup-azure-policy-configure-diagnostics/detailed-policy-definition.png)

5. ブレードの上部にある **[割り当て]** ボタンをクリックします。 これにより、 **[ポリシーの割り当て]** ブレードにリダイレクトされます。

6. **[基本]** で、 **[スコープ]** フィールドの横にある 3 つのドットをクリックします。 これにより、適切なコンテキスト ブレードが開き、ポリシーを適用するサブスクリプションを選択できます。 必要に応じて、リソース グループを選択して、特定のリソース グループ内のコンテナーに対してのみポリシーが適用されるようにすることもできます。

![ポリシー割り当ての基本](./media/backup-azure-policy-configure-diagnostics/policy-assignment-basics.png)

7. **[パラメーター]** で、次の情報を入力します。

* **[プロファイル名]** - ポリシーによって作成された診断設定に割り当てられる名前。
* **Log Analytics ワークスペース** - 診断設定関連付けられたLog Analytics ワークスペース。 ポリシー割り当てのスコープ内にあるすべてのコンテナーの診断データは、指定された LA ワークスペースにプッシュされます。

* **除外タグ名 (省略可能) と除外タグ値 (省略可能)** - 特定のタグ名と値を含むコンテナーをポリシー割り当てから除外するように選択できます。 たとえば、タグ 「isTest」が値「yes」に設定されている資格情報コンテナーに診断設定を追加したく**ない**場合は、**除外タグ名** フィールドに「isTest」を入力し、**除外タグ値** フィールドに「yes」を入力する必要があります。 これら 2 つのフィールドのいずれか (または両方) が空のままになっている場合、ポリシーは、含まれているタグに関係なく、関連するすべてのポリシー コンテナーに適用されます。

![ポリシー割り当てパラメーター](./media/backup-azure-policy-configure-diagnostics/policy-assignment-parameters.png)

8. **修復タスクを作成する** - ポリシーがスコープに割り当てられると、そのスコープ内に作成された新しいタスク作成するコンテナーによって、自動的に LA 診断設定が構成されます (コンテナーの作成時点から 30 分以内)。 スコープ内の既存のコンテナーに診断設定を追加するには、ポリシーの割り当て時に修復タスクをトリガーできます。 修復タスクをトリガーするには、 **[修復タスクを作成]** チェックボックスをオンにします。 

![ポリシー割り当ての修復](./media/backup-azure-policy-configure-diagnostics/policy-assignment-remediation.png)

9. **[レビュー + 作成]** に移動し、 **[作成]** をクリックします。

## <a name="under-what-conditions-will-the-remediation-task-apply-to-a-vault"></a>どのような条件で修復タスクがコンテナーに適用されますか？

修復タスクは、ポリシーの定義に従って非準拠であるコンテナーに適用されます。 次のいずれかの条件を満たしている場合、コンテナーは非準拠になります。

* コンテナーの診断設定が存在しない。
* コンテナーの診断設定は存在するが、いずれの設定も、同期先として LA で有効にされた**すべての**のリソース固有イベントと、トグルの**リソース固有**が選択されていない。 

したがって、AzureDiagnostics モード (バックアップ レポートでサポートされています) で AzureBackupReport イベントが有効になっているコンテナーをユーザーが持っている場合でも、このコンテナーには修復タスクが適用されます。これは、 [今後も](https://docs.microsoft.com/azure/backup/backup-azure-diagnostic-events#legacy-event)リソース固有のモードが診断設定を作成するための推奨される方法です。

さらに、6 つのリソース固有のイベントのサブセットのみが有効になっているコンテナーをユーザーが持っている場合、このコンテナーには修復タスクが適用されます。これは、6 つのリソース固有のイベントがすべて有効になっている場合にのみバックアップ レポートが期待どおりに動作するためです。

> [!NOTE]
>
> コンテナーに既存の診断設定があり、**リソース固有のサブセット**カテゴリが有効になっていて、特定の LA ワークスペースにデータを送信するように設定されている場合で、ポリシー割り当てで指定されたコピー先の LA ワークスペースが**同じ**「ワークスペース X」の場合、ワークスペース名を「ワークスペース X」とすると、修復タスクは失敗します（そのコンテナーのみ)。 
>
>これは、同じリソースに対して2つの異なる診断設定によって有効にされたイベントが、何らかの形式で **重複** している場合に、設定がコピー先と同じ LA ワークスペースを持つことができないためです。 関連するコンテナーに移動し、別の LA ワークスペースでコピー先として診断設定を構成することにより、このエラーを手動で解決する必要があります。
>
> 既存の診断設定が、ワークスペース X で変換先として有効になっている場合にのみ、修復 タスクは失敗**しない** ことにご注意ください。この場合、既存の設定によって有効になっているイベントと、修復タスクによって作成された設定によって有効になったイベントとの間で重複が発生しないためです。

## <a name="next-steps"></a>次の手順

* [バックアップ レポートの使用方法](https://docs.microsoft.com/azure/backup/configure-reports)
* [Azure Policy に関する詳細情報](https://docs.microsoft.com/azure/governance/policy/)
* [Azure Policy を使用して、指定したスコープ内のすべての VM のバックアップを自動的に有効にします。](https://docs.microsoft.com/azure/backup/backup-azure-auto-enable-backup)
