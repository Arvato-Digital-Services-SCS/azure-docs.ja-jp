---
title: Azure Files のネットワークに関する考慮事項 | Microsoft Docs
description: Azure Files のネットワーク オプションの概要。
author: roygara
ms.service: storage
ms.topic: overview
ms.date: 10/19/2019
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 596479652478bffb6d18a90fc53d5972b3839408
ms.sourcegitcommit: b45ee7acf4f26ef2c09300ff2dba2eaa90e09bc7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/30/2019
ms.locfileid: "73126538"
---
# <a name="azure-files-networking-considerations"></a>Azure Files のネットワークに関する考慮事項 
Azure ファイル共有には、次の 2 つの方法で接続できます。

- SMB または FileREST プロトコル経由で直接共有にアクセスします。 このアクセス パターンは主に、できるだけ多くのオンプレミス サーバーを排除するために使用されます。
- Azure File Sync を使用してオンプレミス サーバー上に Azure ファイル共有のキャッシュを作成し、ユース ケースに合った任意のプロトコル (SMB、NFS、FTPS など) を使用してオンプレミス サーバーからファイル共有のデータにアクセスします。 このアクセス パターンは、オンプレミスのパフォーマンスとクラウド スケールの両方、およびサーバーレスの接続可能なサービス (Azure Backup など) のメリットが組み合わされるために非常に便利です。

この記事では、Azure File Sync を使用するのではなく、直接 Azure ファイル共有にアクセスするためにユース ケースに必要となるネットワークの構成方法に重点を置いています。Azure File Sync のデプロイのネットワークに関する考慮事項の詳細については、[Azure File Sync のプロキシとファイアウォールの設定の構成](storage-sync-files-firewall-and-proxy.md)に関するページを参照してください。

## <a name="storage-account-settings"></a>Storage アカウントの設定
ストレージ アカウントは、複数のファイル共有だけでなく、BLOB コンテナーやキューなどのその他のストレージ リソースをデプロイできるストレージの共有プールを表す管理構造です。 Azure ストレージ アカウントは、ネットワークをセキュリティで保護するための 2 つの基本的な設定のセットである、転送中の暗号化とファイアウォールおよび仮想ネットワーク (VNet) を公開します。

### <a name="encryption-in-transit"></a>転送中の暗号化
既定では、すべての Azure ストレージ アカウントで転送中の暗号化が有効になっています。 つまり、SMB 経由でファイル共有をマウントするか、または FileREST プロトコル (Azure portal、PowerShell/CLI、Azure SDK など) 経由でファイル共有にアクセスすると、Azure Files では、暗号化または HTTPS が設定されている SMB 3.0 以上で作成された接続のみが許可されます。 SMB 3.0 をサポートしていないクライアント、または SMB 3.0 をサポートしているが、SMB 暗号化をサポートしていないクライアントは、転送中の暗号化が有効になっている場合は Azure ファイル共有をマウントできません。 どのオペレーティング システムが暗号化付き SMB 3.0 をサポートしているかの詳細については、[Windows](storage-how-to-use-files-windows.md)、[macOS](storage-how-to-use-files-mac.md)、および [Linux](storage-how-to-use-files-linux.md) に関する当社の詳細なドキュメントを参照してください。 PowerShell、CLI、および SDK の現在のバージョンはすべて HTTPS をサポートしています。  

Azure ストレージ アカウントでの転送中の暗号化を無効にすることができます。 暗号化が無効になっている場合、Azure Files では、SMB 2.1、暗号化なしの SMB 3.0、および HTTP 経由の暗号化されていない FileREST API 呼び出しも許可されます。 転送中の暗号化を無効にする主な理由は、古いオペレーティング システム (Windows Server 2008 R2 や古い Linux ディストリビューションなど) 上で実行する必要のあるレガシ アプリケーションをサポートするためです。 Azure Files では、Azure ファイル共有と同じ Azure リージョン内の SMB 2.1 接続のみが許可されます。Azure ファイル共有の Azure リージョンの外部 (オンプレミスまたは異なる Azure リージョン内など) の SMB 2.1 クライアントは、ファイル共有にアクセスできません。

転送中の暗号化の詳細については、「[Azure Storage で安全な転送が必要](../common/storage-require-secure-transfer.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json)」を参照してください。

### <a name="firewalls-and-virtual-networks"></a>ファイアウォールと仮想ネットワーク 
ファイアウォールは、ストレージ アカウントでどの要求が Azure ファイル共有やその他のストレージ リソースへのアクセスを許可されるかを示すネットワーク ポリシーです。 ストレージ アカウントは、既定のネットワーク設定で作成されたときに特定のネットワークには制限されないため、インターネットでアクセスできます。 これは、そのストレージ アカウントでホストされている Azure ファイル共有に格納されたデータにインターネット上のだれからでもアクセスできるということではなく、そのストレージ アカウントが任意のネットワークからの承認された要求を受け入れることを示します。 要求は、ストレージ アカウント キー、共有アクセス署名 (SAS) トークン (FileREST のみ)、または Active Directory ユーザー プリンシパルで承認できます。 

ストレージ アカウントのファイアウォール ポリシーを使用すると、アクセスを特定の IP アドレスまたは範囲、あるいは仮想ネットワークに制限できます。 一般に、ストレージ アカウントのほとんどのファイアウォール ポリシーはネットワーク アクセスを仮想ネットワークに制限します。 

[仮想ネットワーク](../../virtual-network/virtual-networks-overview.md) (VNet) は、独自のデータセンターで運用する従来のネットワークに似ています。 そこでは、ユーザーが Azure リソースのためのセキュリティで保護された通信チャネル (Azure ファイル共有、VM、SQL Database など) を作成して相互に通信できます。 Azure ストレージ アカウントや Azure VM と同様に、VNet は、リソース グループにデプロイされる Azure リソースです。 追加のネットワーク構成を使用すると、Azure VNet をオンプレミス ネットワークに接続することもできます。

Azure VM などのリソースが仮想ネットワークに追加されると、仮想マシンに接続されている仮想ネットワーク インターフェイス (NIC) は、特にその VNet に制限されます。 これは、Azure VM が (当然 NIC を備えた) 仮想化されたコンピューターであるために可能になります。 仮想マシンは、Azure のサービスとしてのインフラストラクチャ (IaaS) 製品ラインナップの一部として提供されます。 Azure ファイル共有はサーバーレスのファイル共有であるため、ユーザーが VNet に追加するための NIC を備えていません。 言い換えると、Azure Files は、Azure のサービスとしてのプラットフォーム (PaaS) 製品ラインナップの一部として提供されます。 ストレージ アカウントを VNet の一部にできるようにするために、Azure では、サービス エンドポイントと呼ばれる PaaS サービスの概念がサポートされています。 サービス エンドポイントを使用すると、PaaS サービスを仮想ネットワークの一部にすることができます。 サービス エンドポイントの詳細については、「[仮想ネットワーク サービス エンドポイント](../../virtual-network/virtual-network-service-endpoints-overview.md)」を参照してください。

ストレージ アカウントは 1 つ以上の仮想ネットワークに追加できます。 ストレージ アカウントを仮想ネットワークに追加したり、他のファイアウォール設定を構成したりする方法の詳細については、[Azure Storage ファイアウォールおよび仮想ネットワークの構成](../common/storage-network-security.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json)に関するページを参照してください。

## <a name="azure-networking"></a>Azure のネットワーク
既定では、Azure Files を含む Azure サービスにはインターネット経由でアクセスできます。 既定ではストレージ アカウントへのトラフィックは暗号化される (また、Azure リージョンの外部で SMB 2.1 マウントが許可されることはない) ため、インターネット経由での Azure ファイル共有へのアクセスに関して本質的に安全でないことは何も存在しません。 組織のポリシーまたは固有の規制要件によっては、Azure とのより制限的な通信が必要になる可能性があるため、Azure には Azure の外部からのトラフィックが Azure Files に到達する方法を制限するためのいくつかの方法が用意されています。 次のサービス オファリングを使用して Azure ファイル共有にアクセスする場合は、ネットワークをさらにセキュリティで保護できます。

- [Azure VPN Gateway](../../vpn-gateway/vpn-gateway-about-vpngateways.md): VPN ゲートウェイは、暗号化されたトラフィックをインターネット経由で Azure 仮想ネットワークと別の場所 (オンプレミスなど) の間で送信するために使用される特定の種類の仮想ネットワーク ゲートウェイです。 Azure VPN Gateway は、ストレージ アカウントまたはその他の Azure リソースと共にリソース グループにデプロイできる Azure リソースです。 VPN ゲートウェイは、次の 2 つの異なる種類の接続を公開します。
    - [ポイント対サイト (P2S) VPN](../../vpn-gateway/point-to-site-about.md) ゲートウェイ接続。これは、Azure と個々のクライアントの間の VPN 接続です。 このソリューションは主に、自宅、コーヒー ショップ、または出先のホテルから自分の Azure ファイル共有をマウントできるようにしたい在宅勤務者などの、組織のオンプレミス ネットワークの一部ではないデバイスに役立ちます。 Azure Files で P2S VPN 接続を使用するには、接続したいクライアントごとに P2S VPN 接続を構成する必要があります。 
    - [サイト間 (S2S) VPN](../../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)。これは、Azure と組織のネットワークの間の VPN 接続です。 S2S VPN 接続を使用すると、Azure ファイル共有にアクセスする必要のあるクライアント デバイスごとにではなく、組織のネットワークでホストされている VPN サーバーまたはデバイスについて 1 回 VPN 接続を構成するだけで済みます。
- [ExpressRoute](../../expressroute/expressroute-introduction.md)。これにより、Azure とインターネットを経由しないオンプレミス ネットワークの間に定義されたルートを作成できます。 ExpressRoute はオンプレミスのデータセンターと Azure の間の専用のパスを提供するため、ExpressRoute は、ネットワーク パフォーマンスが考慮事項であるときに役立つことがあります。 ExpressRoute はまた、組織のポリシーまたは規制要件にクラウド内のリソースへの確定的なパスが必要な場合の適切なオプションでもあります。

## <a name="securing-access-from-on-premises"></a>オンプレミスからのアクセスのセキュリティ保護 
汎用のファイル共有 (Office ドキュメント、PDF、CAD ドキュメントなど) を Azure Files に移行する場合、ユーザーは通常、自分のファイルに引き続きワークステーション、ラップトップ、タブレットなどのオンプレミスのデバイスからアクセスする必要があります。 汎用のファイル共有に関する主な考慮事項は、オンプレミスのユーザーがインターネットまたは WAN 経由で自分のファイル共有に安全にアクセスできる方法です。

オンプレミスから Azure ファイル共有にアクセスする最も簡単な方法は、SMB が使用するポートであるポート 445 へのオンプレミス ネットワークを開き、Azure portal によって提供される UNC パスをマウントすることです。 これに特殊なネットワークは必要ありません。 多くの顧客は、Microsoft がインターネットで安全なプロトコルとは見なしていない SMB 1.0 に関する時代遅れのセキュリティ ガイダンスのために、ポート 445 を開くことに気乗りしません。 Azure Files は SMB 1.0 を実装していません。 

SMB 3.0 は、インターネットで安全なファイル共有プロトコルにするという明示的な要件で設計されました。 そのため、SMB 3.0 以上を使用する場合、コンピューター ネットワークの観点からは、ポート 445 を開くことは HTTPS 接続に使用されるポートであるポート 443 を開くことと何も変わりません。 セキュリティで保護されていない SMB 1.0 トラフィックを防止するためにポート 445 をブロックするのではなく、Microsoft は次の手順をお勧めします。

> [!Important]  
> 送信トラフィックに対してポート 445 を閉じたままにすることを決定した場合でも、Microsoft は引き続き、環境から SMB 1.0 を削除するために次の手順をお勧めします。

1. 組織のデバイス上で SMB 1.0 が削除されているか、または無効になっていることを確認します。 現在サポートされているすべてのバージョンの Windows および Windows Server で SMB 1.0 の削除または無効化がサポートされており、Windows 10 バージョン 1709 からは、SMB 1.0 が既定では Windows 上にインストールされません。 SMB 1.0 を無効にする方法の詳細については、次の OS 固有のページを参照してください。
    - [Windows/Windows Server のセキュリティ保護](storage-how-to-use-files-windows.md#securing-windowswindows-server)
    - [Linux のセキュリティ保護](storage-how-to-use-files-linux.md#securing-linux)
1. SMB 1.0 が必要な製品が組織内に存在しないことを確認し、存在する場合はそれを削除します。 Microsoft は、SMB 1.0 が必要であると Microsoft で認識しているすべてのファーストパーティ製品とサードパーティ製品が含まれた [SMB1 製品クリアリングハウス](https://aka.ms/stillneedssmb1)を保持しています。 
1. (省略可能) 組織のオンプレミス ネットワークでサードパーティのファイアウォールを使用して、SMB 1.0 トラフィックを防止します。

組織でポリシーまたは規制に従ってポート 445 をブロックする必要がある場合は、Azure VPN Gateway または ExpressRoute を使用して、ポート 443 経由でトラフィックをトンネリングできます。 これらをデプロイするための具体的な手順の詳細については、次の個別のハウツー ページを参照してください。
- [Azure Files で使用するサイト間 (S2S) VPN を構成する](storage-files-configure-s2s-vpn.md)
- [Windows 上で Azure Files で使用するポイント対サイト (P2S) VPN を構成する](storage-files-configure-p2s-vpn-windows.md)
- [Linux 上で Azure Files で使用するポイント対サイト (P2S) VPN を構成する](storage-files-configure-p2s-vpn-linux.md)

組織には、オンプレミス サイトからの送信トラフィックがクラウド内のリソースへの確定的なパスに従う必要があるという追加の要件がある場合があります。 その場合は、ExpressRoute がこの要件を満たすことができます。

## <a name="securing-access-from-cloud-resources"></a>クラウド リソースからのアクセスのセキュリティ保護
一般に、オンプレミスのアプリケーションがクラウドにリフト アンド シフトされると、そのアプリケーションとアプリケーションのデータは同時に移動されます。 つまり、リフト アンド シフト移行に関する主な考慮事項は、Azure ファイル共有へのアクセスを、動作するためにファイル共有へのアクセスが必要な特定の仮想マシンまたは Azure サービスにロックダウンすることです。 

VNet を使用して、どの VM またはその他の Azure リソースがネットワーク接続 (Azure ファイル共有への SMB マウントまたは REST API 呼び出し) の実行を許可されるかを制限することもできます。 ストレージ アカウントへの暗号化されていないトラフィックを許可する場合は、Azure ファイル共有を常に VNet 内に配置することをお勧めします。 それ以外の場合、VNet を使用するかどうかは、ビジネス要件や組織のポリシーに基づいて行われるべき意思決定です。

Azure ファイル共有への暗号化されていないトラフィックを許可する主な理由は、Windows Server 2008 R2、Windows 7、またはその他の古い OS による SMB 2.1 (一部の Linux ディストリビューションでは暗号化なしの SMB 3.0) での Azure ファイル共有へのアクセスをサポートするためです。 暗号化付きの SMB 3.0 以上をサポートするオペレーティング システムで SMB 2.1 または暗号化なしの SMB 3.0 を使用することはお勧めしません。

## <a name="see-also"></a>関連項目
- [Azure Files の概要](storage-files-introduction.md)
- [Azure Files のデプロイの計画](storage-files-planning.md)