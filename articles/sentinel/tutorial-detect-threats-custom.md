---
title: Azure Sentinel を使用して疑わしい脅威を検出するカスタム分析ルールを作成する | Microsoft Docs
description: このチュートリアルでは、Azure Sentinel で疑わしい脅威を検出するカスタム分析ルールを作成する方法について説明します。
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/20/2020
ms.author: yelevin
ms.openlocfilehash: cea7429ecea105355b0afe306bfa334e55d5d9c4
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "77585109"
---
# <a name="tutorial-create-custom-analytic-rules-to-detect-suspicious-threats"></a>チュートリアル:疑わしい脅威を検出するカスタム分析ルールを作成する

Azure Sentinel に [データ ソースを接続](quickstart-onboard.md) した後、環境全体で特定の条件を検索し、条件が一致したときにインシデントを生成するカスタム ルールを作成して、それらを調査できるようにすることができます。 このチュートリアルは、Azure Sentinel で脅威を検出するカスタム ルールを作成するために役立ちます。

このチュートリアルは、Azure Sentinel で脅威を検出するためのものです。
> [!div class="checklist"]
> * 分析ルールを作成する
> * 脅威への対応を自動化する

## <a name="create-custom-analytic-rules"></a>カスタム分析ルールを作成する

環境内で疑わしい脅威や異常の種類を検索するために役立つカスタム分析ルールを作成することができます。 このルールによって直ちに通知されるので、脅威のトリアージ、調査、および修復を行うことができます。

1. Azure portal の Azure Sentinel の下で **[Analytics]** を選択します。

1. 上部のメニュー バーで、 **[+ 作成]** を選択し、 **[スケジュール済みクエリ ルール]** を選択します。 **分析ルール ウィザード**が開きます。

    ![スケジュール済みクエリを作成する](media/tutorial-detect-threats-custom/create-scheduled-query.png)

1. **[全般]** タブで、一意の **[名前]** と **[説明]** を指定します。 **[方針]** フィールドでは、ルールを分類する攻撃のカテゴリを選択できます。 必要に応じて、アラートの **[重大度]** を設定します。 ルールを作成すると、その **[状態]** は既定で **[有効]** になります。これは、作成が終わるとすぐに実行されることを意味します。 すぐに実行したくない場合は、 **[無効]** を選択します。ルールは **[アクティブな規則]** タブに追加され、必要に応じてそこから有効にすることができます。

    ![カスタム分析ルールの作成を開始する](media/tutorial-detect-threats-custom/general-tab.png)

1. **[ルールのロジックを設定]** タブでは、 **[ルールのクエリ]** フィールドにクエリを直接入力するか、または Log Analytics でクエリを作成し、コピーしてフィールドに貼り付けることができます。
 
   ![Azure Sentinel でクエリを作成する](media/tutorial-detect-threats-custom/settings-tab.png)

   - 右側にある **[結果のプレビュー]** 領域には、クエリによって生成される結果 (ログ イベント) の数を示され、クエリの記述と構成に合わせてリアルタイムに変更されます。 グラフには、定義された期間における結果の数が表示されます。これは、 **[クエリのスケジュール設定]** セクションの設定によって決まります。
    - クエリによってトリガーされるアラートが多すぎたり、頻繁すぎたりする場合は、 **[アラートのしきい値]** セクションでベースラインを設定できます。

      異常な数のリソースが Azure アクティビティで作成されたときにアラートを発するサンプル クエリを次に示します。

      `AzureActivity
     \| where OperationName == "Create or Update Virtual Machine" or OperationName =="Create Deployment"
     \| where ActivityStatus == "Succeeded"
     \| make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller`

      > [!NOTE]
      > クエリの長さは 1 から 10,000 文字にする必要があります。また、"search \*" または "union \*" を含めることはできません。

    1. クエリ結果のパラメーターを Azure Sentinel で認識されるエンティティにリンクするには、 **[エンティティのマップ]** セクションを使用します。 これらのエンティティにより、 **[Incident settings]\(インシデントの設定\)** タブでのインシデントへのアラートのグループ化など、詳細な分析のための基礎が形成されます。
    1. **[クエリのスケジュール設定]** セクションで、次のパラメーターを設定します。

       1. **[クエリの実行間隔]** の設定では、クエリが実行される頻度 (頻繁な 5 分間隔、または 1 日に 1 回程度の低い頻度) を制御します。

       1. **[次の時間分の過去のデータを参照します]** の設定では、クエリの対象となるデータの期間を決定します。たとえば、過去 10 分間や過去 6 時間のデータのクエリを実行できます。

       > [!NOTE]
       > これら 2 つの設定は、ある程度まで互いに独立しています。 間隔より長い期間をカバーする短い間隔でクエリを実行できますが (重複するクエリがある場合)、カバレッジ期間を超える間隔でクエリを実行することはできません。そうしないと、クエリ カバレッジ全体にギャップが生じることになります。

    1. ベースラインを定義するには、 **[アラートのしきい値]** セクションを使用します。 たとえば、クエリが実行されるたびに 1,000 件を超える結果が生成される場合にのみアラートを生成するようにルールを設定する場合は、 **[クエリ結果件数でアラートを生成する]** を **[次の値より大きい]** に設定し、値として 1,000 を入力します。 これは必須フィールドであるため、ベースラインを設定したくない場合、つまりアラートですべてのイベントを登録する場合は、値フィールドに「0」と入力します。

    1. アラートが生成された後、クエリ間隔を超える期間だけこのルールの操作を中断する場合は、 **[抑制]** セクションで、 **[アラートの生成後にクエリの実行を停止する]** の設定を **[オン]** にすることができます。 これをオンにする場合は、 **[クエリの実行を停止する]** をクエリの実行を停止する時間 (最大 24 時間) に設定する必要があります。

1. **[Incident Settings]\(インシデントの設定\)** タブでは、アラートをアクションにつながるインシデントに変換するかどうか、およびその方法を選択できます。 このタブを設定しないと、すべてのアラートに対して個別に 1 つのインシデントが作成されます。 このタブの設定を変更することで、インシデントを作成しないようにしたり、複数のアラートを 1 つのインシデントにグループ化したりすることができます。

    1. **[Incident Settings]\(インシデントの設定\)** セクションでは、 **[この分析ルールによってトリガーされるアラートからインシデントを作成する]** が既定で **[有効]** に設定されています。つまり、ルールによってトリガーされるすべての個々のアラートから、1 つの個別のインシデントが作成されます。<br></br>このルールによってインシデントが作成されないようにする場合は (たとえば、このルールが後続の分析のために情報を収集するだけの場合)、これを **[無効]** に設定します。

    1. **[Alert grouping]\(アラートのグループ化\)** セクションでは、似たアラートまたは繰り返し発生するアラートのグループから単一のインシデントを生成する場合は、 **[この分析ルールによってトリガーされる関連アラートをインシデントにグループ化する]** を **[有効]** に設定し、次のパラメーターを設定します。

    1. **[選択した期間内に作成されたアラートのみにグループを制限する]** :<br></br> 似たアラートまたは繰り返し発生するアラートをグループ化する期間を決定します。 この期間内の対応するすべてのアラートでは、1 つのインシデントまたはインシデントのセットがまとめて生成されます (以下のグループ化の設定に依存します)。 この期間外のアラートでは、個別のインシデントまたはインシデントのセットが生成されます。

    2. **[この分析ルールによってトリガーされるアラートを次の方法で単一のインシデントにグループ化する]** :アラートをグループ化する基準を選択します。

        - **[すべてのエンティティが一致した場合にアラートを 1 つのインシデントにグループ化する]** : <br></br>マップされている各エンティティ (上の [ルールのロジックを設定] タブで定義したもの) の値が同じ場合、アラートはグループ化されます。 これが推奨される設定です。

        - **[このルールによってトリガーされるすべてのアラートを 1 つのインシデントにグループ化する]** : <br></br>値が同じではない場合でも、このルールによって生成されるすべてのアラートをグループ化します。

        - **[選択したエンティティが一致する場合にアラートを 1 つのインシデントにグループ化する]** : <br></br>マップされたエンティティの一部 (ドロップダウン リストから選択可能) の値が同じ場合、アラートをグループ化します。 たとえば、ソースまたはターゲットの IP アドレスに基づいて個別のインシデントを作成する場合に、この設定を使用できます。

    3. **[Re-open closed matching incidents]\(クローズされた一致するインシデントを再度開く\)** :あるインシデントがクローズされた (基になる問題が解決されたことを意味します) 後で、そのインシデントにグループ化されている別のアラートが生成されたとき、クローズされたインシデントを再び開く場合はこの設定を **[有効]** に設定し、新しいインシデントを作成する場合は **[無効]** のままにします。

1. **[Automated responses]\(対応の自動化\)** タブでは、カスタム ルールによってアラートが生成されたときに自動的に実行するプレイブックを選択します。 プレイブックの作成と自動化の詳細については、 [脅威への対応](tutorial-respond-threats-playbook.md)に関する記事を参照してください。

1. **[確認と作成]** を選択して新しいアラート ルールのすべての設定を確認し、 **[Create to initialize your alert rule]\(アラート ルールを作成して初期化\)** を選択します。
  
1. アラートが作成されると、 **[Active rules]\(アクティブなルール\)** のテーブルにカスタム ルールが作成されます。 この一覧から、各ルールを有効にしたり、無効にしたり、削除したりできます。

1. 作成したアラート ルールの結果を表示するには、 **[インシデント]** ページに移動します。ここでは、トリアージ、 [インシデントの調査](tutorial-investigate-cases.md)、脅威の修復を行うことができます。


> [!NOTE]
> Azure Sentinel で生成されたアラートは、 [Microsoft Graph Security](https://aka.ms/securitygraphdocs) を通じて使用できます。 詳細については、 [Microsoft Graph のセキュリティ アラートのドキュメント](https://aka.ms/graphsecurityreferencebetadocs)を参照してください。

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、Azure Sentinel を使用して、脅威の検出を開始する方法について説明しました。

脅威への対応を自動化する方法については、「 [Azure Sentinel で脅威への自動対応を設定する](tutorial-respond-threats-playbook.md)」を参照してください。

