---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 02/27/2020
ms.author: ccompy
ms.openlocfilehash: c731e2a7d4da1a66aabb50b335d526fbb6a0a302
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2020
ms.locfileid: "78671525"
---
リージョン VNet 統合を使用すると、アプリは次のものにアクセスできるようになります。

* 統合するのと同じリージョン内の VNet 内のリソース 
* 同じリージョンにある VNet とピアリングされた VNet 内のリソース
* サービス エンドポイントでセキュリティ保護されたサービス
* ExpressRoute 接続にまたがるリソース
* 接続されている VNet 内のリソース
* ExpressRoute 接続を含むピアリングされた接続にまたがるリソース
* プライベート エンドポイント 

同じリージョンの VNet との VNet 統合を使用する場合は、次の Azure ネットワーク機能を使用できます。

* ネットワーク セキュリティ グループ (NSG) - 統合サブネットに配置されているネットワーク セキュリティ グループを使用して送信トラフィックをブロックできます。 VNet 統合を使用してアプリへの受信アクセスを提供できないため、受信規則は適用されません。
* ルート テーブル (UDR) - 統合サブネットにルート テーブルを配置し、必要な場所に送信トラフィックを送信できます。 

既定では、アプリは RFC1918 トラフィックのみを VNet にルーティングします。 すべての送信トラフィックを VNet にルーティングする場合は、アプリの設定 WEBSITE_VNET_ROUTE_ALL をアプリに適用します。 アプリ設定を構成するには、次のようにします。

1. アプリ ポータルの [構成] UI にアクセスします。 **[新しいアプリケーション設定]** を選択します
1. [名前] フィールドに「**WEBSITE_VNET_ROUTE_ALL**」、[値] フィールドに「**1**」と入力します。

   ![アプリケーション設定を指定する][4]

1. **[OK]** を選択します。
1. **[保存]** を選びます。

すべての送信トラフィックを VNet にルーティングする場合は、統合サブネットに適用される NSG と UDR の対象となります。 すべての送信トラフィックを VNet にルーティングすると、トラフィックを他の場所に送信するためのルートを指定しない限り、送信アドレスはアプリのプロパティに一覧表示される送信アドレスになります。 

同じリージョンの VNet との VNet 統合を使用する場合、いくつかの制限があります。

* グローバル ピアリング接続にまたがるリソースには到達できません。
* この機能は、PremiumV2 の App Service プランをサポートする新しい App Service スケール ユニットからのみ使用できます。
* 統合サブネットは、1 つの App Service プランでしか使用できません。
* この機能は、App Service Environment にある Isolated プランのアプリでは使用できません。
* この機能では、Resource Manager VNet 内に 32 個以上のアドレスを含む /27 である未使用のサブネットが必要です。
* アプリと VNet は同じリージョンに存在する必要があります。
* 統合アプリで VNet を削除することはできません。 VNet を削除する前に統合を削除してください。 
* アプリと同じサブスクリプション内 VNet とのみ統合できます。
* App Service プランごとに 1 リージョンの VNet 統合のみを持つことができます。 同じ App Service プラン内の複数のアプリが同じ VNet を使用できます。 
* リージョン VNet 統合を使用しているアプリがあるときに、アプリまたはプランのサブスクリプションを変更することはできません。

プランのインスタンスごとに 1 つのアドレスが使用されます。 アプリを 5 つのインスタンスにスケールする場合は、5 つのアドレスが使用されます。 割り当てた後はサブネット サイズを変更できないため、アプリが到達する可能性のあるスケールに対応できるだけの十分な大きさを持つサブネットを使用する必要があります。 推奨されるサイズは、64 のアドレスを持つ /26 です。 64 個のアドレスを持つ /26 は、Premium プランの 30 インスタンスに対応します。 プランをスケールアップまたはスケールダウンする場合は、短時間に 2 倍の数のアドレスが必要になります。 

別のプランのアプリで、別のプランのアプリから既に接続されている VNet に到達するようにしたい場合は、既存の VNet 統合によって使用されているものとは異なるサブネットを選択する必要があります。  

この機能は、Linux ではプレビュー段階にあります。 Linux 形式の機能では、RFC 1918 アドレス (10.0.0.0/8、172.16.0.0/12、192.168.0.0/16) への呼び出しのみがサポートされます。

### <a name="web--function-app-for-containers"></a>Web App for Containers / Function App for Containers

Linux 上のアプリを組み込みイメージでホストする場合、リージョン VNet 統合は追加の変更なしで機能します。 Web App for Containers / Function App for Containers を使用している場合は、VNet 統合を使用するために docker イメージを変更する必要があります。 docker イメージで、ハードコーディングされたポート番号を使用するのではなく、メイン Web サーバーのリスニング ポートとして PORT 環境変数を使用します。 PORT 環境変数は、コンテナーの起動時にプラットフォームによって自動的に設定されます。 SSH を使用している場合は、リージョン VNet 統合を使用するときに SSH_PORT 環境変数で指定されたポート番号でリッスンするように SSH デーモンを構成する必要があります。  Linux では、ゲートウェイが必要な VNet 統合はサポートされていません。 

### <a name="service-endpoints"></a>サービス エンドポイント

リージョン VNet 統合では、サービス エンドポイントを使用できます。  アプリでサービス エンドポイントを使用するには、リージョン VNet 統合を使用し、選択した VNet に接続してから、統合に使用したサブネット上のサービス エンドポイントを構成します。 

### <a name="network-security-groups"></a>ネットワーク セキュリティ グループ

ネットワーク セキュリティ グループを使用すると、VNet 内のリソースへの受信および送信トラフィックをブロックできます。 リージョン VNet 統合を使用するアプリでは、[ネットワーク セキュリティ グループ][VNETnsg]を使用して、VNet またはインターネット内のリソースへの送信トラフィックをブロックできます。 パブリック アドレスへのトラフィックをブロックするには、WEBSITE_VNET_ROUTE_ALL アプリケーション設定を 1 に設定する必要があります。 NSG の受信規則はアプリに適用されません。これは、VNet 統合がアプリからの送信トラフィックにのみ影響するためです。 アプリへの受信トラフィックを制御するには、アクセス制限機能を使用します。 統合サブネットに適用される NSG は、統合サブネットに適用されているルートに関係なく有効になります。 WEBSITE_VNET_ROUTE_ALL が 1 に設定されていて、統合サブネットでパブリック アドレス トラフィックに影響を与えるルートがない場合、すべての送信トラフィックは、統合サブネットに割り当てられた NSG の対象となります。 WEBSITE_VNET_ROUTE_ALL が設定されていない場合、NSG は RFC1918 トラフィックにのみ適用されます。

### <a name="routes"></a>ルート

ルート テーブルを使用すると、アプリからの送信トラフィックを任意の場所にルーティングすることができます。 既定では、ルート テーブルは、RFC1918 の送信先トラフィックにのみ影響します。  WEBSITE_VNET_ROUTE_ALL を 1 に設定すると、すべての送信呼び出しが影響を受けます。 統合サブネットで設定されているルートは、受信アプリ要求への応答には影響しません。 一般的な宛先には、ファイアウォール デバイスまたはゲートウェイを含めることができます。 オンプレミスのすべての送信トラフィックをルーティングする場合は、ルート テーブルを使用して、すべての送信トラフィックを ExpressRoute ゲートウェイに送信できます。 ゲートウェイにトラフィックをルーティングする場合は、外部ネットワークのルートを設定して、応答を返信するようにしてください。

Border Gateway Protocol (BGP) ルートもアプリのトラフィックに影響を与えます。 ExpressRoute ゲートウェイのようなものから BGP ルートを使用している場合は、アプリの送信トラフィックが影響を受けます。 既定では、BGP ルートは、RFC1918 の送信先トラフィックにのみ影響します。 WEBSITE_VNET_ROUTE_ALL が 1 に設定されている場合、すべての送信トラフィックは、BGP ルートの影響を受ける可能性があります。 


<!--Image references-->
[4]: ../includes/media/web-sites-integrate-with-vnet/vnetint-appsetting.png

<!--Links-->
[VNETnsg]: https://docs.microsoft.com/azure/virtual-network/security-overview/