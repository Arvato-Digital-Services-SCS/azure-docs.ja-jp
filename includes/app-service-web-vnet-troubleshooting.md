---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 02/27/2020
ms.author: ccompy
ms.openlocfilehash: 2d2a82552a846cedfa5da3bb6ec6df8a40b67732
ms.sourcegitcommit: bc792d0525d83f00d2329bea054ac45b2495315d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2020
ms.locfileid: "78671540"
---
この機能は簡単にセットアップできるものの、問題が発生しないわけではありません。 目的のエンドポイントへのアクセスに関して問題が発生した場合は、アプリのコンソールからの接続テストに、いくつかのユーティリティを利用できます。 利用できるコンソールが 2 つあります。 1 つは Kudu コンソールで、もう 1 つは Azure portal 内のコンソールです。 アプリから Kudu コンソールにアクセスするには、[ツール]、[Kudu] の順に移動します。 [サイト名].scm.azurewebsites.net で Kudo コンソールにアクセスすることもできます。 Web サイトが読み込まれたら、[デバッグ コンソール] タブに移動します。Azure ポータルにホストされたコンソールにアクセスするには、アプリで [ツール]、[コンソール] の順に移動します。 

#### <a name="tools"></a>ツール
**ping**、**nslookup**、**tracert** の各ツールは、セキュリティの制約により、コンソールから使用することはできません。 それを補うために、2 つの独立したツールが追加されています。 DNS 機能のテスト用に、nameresolver.exe という名前のツールを追加しました。 の構文は次のとおりです。

    nameresolver.exe hostname [optional: DNS Server]

**nameresolver** を使用すると、アプリが依存しているホスト名を確認できます。 この方法で、DNS の構成に誤りがあるかどうかや、DNS サーバーへのアクセス権がないかどうかをテストできます。 環境変数 WEBSITE_DNS_SERVER と WEBSITE_DNS_ALT_SERVER を調べることによって、アプリが使用する DNS サーバーをコンソールで確認できます。

次のツールでは、ホストとポートを組み合わせたものへの TCP 接続をテストすることができます。 このツールは **tcpping** という名前で、構文は次のとおりです。

    tcpping.exe hostname [optional: port]

**tcpping** ユーティリティを使用すると、特定のホストとポートにアクセスできるかどうかがわかります。 成功として示されるのは、ホストとポートの組み合わせでリッスンしているアプリケーションがあり、アプリから指定のホストとポートへのネットワーク アクセスがある場合のみです。

#### <a name="debugging-access-to-vnet-hosted-resources"></a>VNet にホストされたリソースへのアクセスのデバッグ
アプリから特定のホストとポートへのアクセスは、さまざまな要因によって妨げられる可能性があります。 ほとんどの場合、次の 3 つのうちのいずれかです。

* **ファイアウォールがルートを塞いでいる。** ルートを塞いでいるファイアウォールがあると、TCP のタイムアウトに達します。 この場合の TCP タイムアウトは 21 秒です。 **tcpping** ツールを使用して接続をテストします。 TCP タイムアウトの原因は、ファイアウォール以外にさまざまなことが考えられますが、まずここから始めます。 
* **DNS にアクセスできない。** DNS タイムアウトは、DNS サーバーごとに 3 秒です。 2 つの DNS サーバーがある場合、タイムアウトは 6 秒です。 nameresolver を使用して、DNS が機能しているかどうかを確認します。 nslookup は使用できないことに注意してください。これは、nslookup が VNet の構成に使用されている DNS を使用しないためです。 アクセスできない場合は、ファイアウォールが存在するか、NSG が DNS へのアクセスをブロックしているか、または DNS が停止している可能性があります。

これらの項目が問題の回答になっていない場合は、まず次のような点を確認してください。 

**リージョン Vnet 統合**
* 宛先は RFC1918 以外のアドレスであり、WEBSITE_VNET_ROUTE_ALL が 1 に設定されていないこと。
* 統合サブネットからのエグレスをブロックしている NSG は存在するか。
* ExpressRoute または VPN をまたがって移動する場合は、オンプレミスのゲートウェイがトラフィック バックアップを Azure にルーティングするように構成されているか。 VNet 内のエンドポイントには到達できるが、オンプレミスに到達できない場合は、ルートを確認します。
* 統合サブネットに委任を設定するための十分なアクセス許可があるか。 リージョン VNet 統合が構成されている間、統合サブネットは Microsoft.Web に委任されます。 VNet 統合 UI では、Microsoft Web に対するサブネットが自動的に委任されます。 アカウントに委任を設定するための十分なネットワークのアクセス許可がない場合は、サブネットを委任するために、統合サブネットに属性を設定できるユーザーが必要になります。 統合サブネットを手動で委任するには、Azure Virtual Network サブネット UI にアクセスして、Microsoft.Web の委任を設定します。 

**ゲートウェイが必要な Vnet 統合**
* ポイント対サイトのアドレス範囲が RFC 1918 の範囲 (10.0.0.0-10.255.255.255/172.16.0.0-172.31.255.255/192.168.0.0-192.168.255.255) にあるか。
* ゲートウェイはポータルに稼働中と表示されているか。 ゲートウェイがダウンしている場合は、再起動してください。
* 証明書は同期していると表示されているか。または、ネットワーク構成が変更されたことが疑われるか。  証明書が同期していないか、または ASP と同期していない VNet 構成への変更が行われたことが疑われる場合は、[ネットワークの同期] をクリックします。
* VPN をまたがって移動する場合は、オンプレミスのゲートウェイがトラフィック バックアップを Azure にルーティングするように構成されているか。 VNet 内のエンドポイントには到達できるが、オンプレミスに到達できない場合は、ルートを確認します。
* ポイント対サイトと ExpressRoute の両方をサポートする共存ゲートウェイを使用しようとしているか。 VNet 統合では、共存ゲートウェイはサポートされていません。

ホストとポートの特定の組み合わせへのアクセスを何がブロックしているかを確認できないため、ネットワークに関する問題のデバッグは課題です。 以下に原因の例を示します。

* ホスト上で稼働しているファイアウォールが、ポイント対サイト IP の範囲からアプリケーション ポートへのアクセスを妨げている。 サブネットの境界を越えるには、多くの場合パブリック アクセスが必要になります。
* ターゲット ホストがダウンしている。
* アプリケーションがダウンしている。
* IP またはホスト名が誤っている。
* アプリケーションが予期しないポートでリッスンしている。 エンドポイント ホストで "netstat-aon" を使用することで、プロセス ID と、リッスンしているポートを一致させることができます。 
* ネットワーク セキュリティ グループが、ポイント対サイト IP の範囲からアプリケーション ホストとポートへのアクセスをブロックするように構成されている。

アプリが実際にどのようなアドレスを使用するかは認識できないことに注意してください。 統合サブネットまたはポイント対サイトのアドレス範囲内の任意のアドレスである可能性があるため、アドレス範囲全体からのアクセスを許可する必要があります。 

追加のデバッグ手順は次のとおりです。

* VNet 内の VM に接続し、そこからリソースのホスト:ポートへのアクセスを試します。 TCP アクセスのテストには、PowerShell コマンド **test-netconnection** を使用します。 の構文は次のとおりです。

      test-netconnection hostname [optional: -Port]

* VM 上でアプリケーションを起動し、**tcpping** を使用して、アプリのコンソールからそのホストとポートへのアクセスをテストします。

#### <a name="on-premises-resources"></a>オンプレミスのリソース ####

アプリがオンプレミスのリソースにアクセスできない場合は、VNet からリソースにアクセスできるかどうかを確認します。 TCP アクセスを確認するには、PowerShell コマンド **test-netconnection** を使用します。 VM がオンプレミス リソースに到達できない場合は、VPN または ExpressRoute 接続が正しく構成されていない可能性があります。

VNet でホストされている VM はオンプレミス システムにアクセスでき、アプリはアクセスできない場合、以下の理由のいずれかが原因と考えられます。

* オンプレミスのゲートウェイで、ルートがサブネットまたはポイント対サイトのアドレス範囲で構成されていない。
* ネットワーク セキュリティ グループが、ポイント対サイト IP 範囲へのアクセスをブロックしている。
* オンプレミスのファイアウォールが、ポイント対サイト IP 範囲からのトラフィックをブロックしている。
* リージョン VNet 統合機能を使用して、RFC 1918 以外のアドレスに到達しようとしている。